var VisorMapa={map:null,canvas:null,emergencyMarker:null,emergencyRadius:null,emergencyDrawingManager:null,otherDrawingManager:null,otherControlColor:null,otherControlDataColor:null,otherControlSelected:null,otherStatusInfoControl:"off"};(function(){var e,t=null;this.init=function(e){this.opciones=e,$.get(siteUrl+"visor/obtenerJsonEmergenciaVisor/id/"+$("#hIdEmergencia").val()).done(this.makeMap.bind(this))},google.maps.Map.prototype.clearMarkers=function(){e&&e.close()},this.makeMap=function(o){for(var r=this,n=JSON.parse(o),i=new google.maps.LatLngBounds,s=0;s<n.coordinates.length;s++){var l=n.coordinates[s];if(l.com_c_xmin&&l.com_c_ymin&&l.com_c_xmax&&l.com_c_ymax){var c=GeoEncoder.utmToDecimalDegree(parseFloat(l.com_c_xmin),parseFloat(l.com_c_ymin),l.com_c_geozone);i.extend(new google.maps.LatLng(c[0],c[1])),c=GeoEncoder.utmToDecimalDegree(parseFloat(l.com_c_xmax),parseFloat(l.com_c_ymax),l.com_c_geozone),i.extend(new google.maps.LatLng(c[0],c[1]))}}this.canvas=$("#mapa").get(0),$(window).resize(this.detectHeight.bind(this));var g={center:new google.maps.LatLng(-33.07,-71.6),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:12},p=$.extend(g,t);this.detectHeight.call(this),this.map=new google.maps.Map(this.canvas,p),this.map.fitBounds(i),this.makeSearchBox.call(this),this.makeEmergencyDrawManager.call(this),this.makeOthersManager.call(this),this.constructControlIns.call(this,n.facilities),this.constructControlInfo.call(this),this.constructControlSave.call(this),this.map.data.setStyle(function(e){var t=null,a={};return e.getProperty("fillColor")&&(t=e.getProperty("color"),a.fillOpacity=.3,a.fillColor=e.getProperty("fillColor")),e.getProperty("strokeColor")&&(a.strokeColor=e.getProperty("strokeColor")),e.getProperty("icon")&&(a.icon=e.getProperty("icon")),a}),this.map.data.addListener("click",function(t){return"on"==r.otherStatusInfoControl?a.call(r,t):void(t.feature.getProperty("infoWindow")&&(e&&e.close(),e=new google.maps.InfoWindow({content:t.feature.getProperty("infoWindow"),position:t.latLng}),e.open(r.map)))}),this.map.addListener("zoom_changed",function(e){$(".contextmenu").remove()}),this.map.addListener("rightclick",function(e){$(".contextmenu").remove()}),this.map.addListener("click",function(e){$(".contextmenu").remove()}),this.map.addListener("dblclick",function(e){$(".contextmenu").remove()}),this.map.data.addListener("rightclick",function(e){e.feature.getProperty("microtime")&&"LUGAR_EMERGENCIA"!==e.feature.getProperty("type")&&r.showContextMenu(e.latLng,e.feature)}),n.geojson&&this.map.data.loadGeoJson(n.geojson,null,function(e){for(var t=0;t<e.length;t++){var a=e[t];"LUGAR_EMERGENCIA"==a.getProperty("type")?r.emergencyMarker=a:"RADIO_EMERGENCIA"==a.getProperty("type")&&(r.emergencyRadius=a)}}),n.capas&&($("#selected_items").val(n.capas),this.cargarCapas())};var a=function(e){if("Polygon"!=e.feature.getGeometry().getType())return null;console.log(e.feature);var t,a,n=o.call(this),i=[],s=new google.maps.Polygon({map:null});for(s.setPaths(e.feature.getGeometry().getAt(0).getArray()),a=0;a<n.length;a++)t=n[a],"Point"==t.getGeometry().getType()&&"LUGAR_EMERGENCIA"!=t.getProperty("type")&&google.maps.geometry.poly.containsLocation(t.getGeometry().get(),s)&&i.push(t);if(0==i.length)return null;var l,c,g,t,p,m,d,h=null,u={},f=["midas","icon","infoWindow","type","TYPE","LAYERNAME","microtime"],y=$("#mInfoContent");u.tipo=[],u.layername=[],u.cols=[];var v;for(a=0;a<i.length;a++){t=i[a],g=0;var h=t;$.each(u.tipo,function(e,t){(h.getProperty("type")==t||h.getProperty("TYPE")==t)&&g++}),0==g&&(v=[],null!=h.getProperty("TYPE")?(u.tipo.push(h.getProperty("TYPE")),u.layername.push(h.getProperty("LAYERNAME")),$.each(r(h),function(e){u.cols.hasOwnProperty(e)||(c={},c.mData=e,c.sTitle=e,-1!=f.indexOf(e)&&(c.bVisible=!1),v.push(c))}),u.cols.push(v)):null!=h.getProperty("type")&&(u.tipo.push(h.getProperty("type")),u.layername.push(h.getProperty("type")),$.each(r(h),function(e){u.cols.hasOwnProperty(e)||(c={},c.mData=e,c.sTitle=e,-1!=f.indexOf(e)&&(c.bVisible=!1),v.push(c))}),u.cols.push(v)))}return console.log(u),y.html(""),y.append('<ul id="ul-tabs" class="nav nav-tabs"></ul>'),$("#ul-tabs").after('<div id="tab-content" class="tab-content"></div>'),$.each(u.tipo,function(e,a){p=u.tipo[e],d=u.layername[e],l={},l.data=[];for(var o=0;o<i.length;o++)t=i[o],(t.getProperty("type")==p||t.getProperty("TYPE")==p)&&l.data.push(r(t));m=0==e?"active":"",$("#ul-tabs").append("<li class="+m+'><a href="#tab'+e+'" data-toggle="tab">'+d+"</a></li>"),$("#tab-content").append("<div class='tab-pane "+m+"' id='tab"+e+"' style='overflow:hidden;'><div id='div_tab_"+e+"' class='col-xs-12 table-responsive'></div></div>"),$("#div_tab_"+e).append("<table id=table_"+e+' class="table table-bordered table-striped"><thead></thead><tbody></tbody><tfoot></tfoot></table>'),$("#table_"+e).DataTable({columns:u.cols[e],data:l.data,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"}})}),$("#mInfo").modal("show"),$("#ctrlInfo").click(),null},o=function(){var e=[];return this.map.data.forEach(function(t){e.push(t)}),e},r=function(e){var t={};return e.forEachProperty(function(e,a){t[a]=e}),t};this.constructControlInfo=function(){var e=this;$("#ctrlInfo").click(function(){return $(this).hasClass("btn-success")?($(this).removeClass("btn-success").addClass("btn-primary"),void(e.otherStatusInfoControl="off")):($(this).removeClass("btn-primary").addClass("btn-success"),void(e.otherStatusInfoControl="on"))})};var n=this;this.constructControlSave=function(){$("#ctrlSave").click(function(){var e={type:"FeatureCollection",features:[]},t=[],a="",o="";n.map.data.forEach(function(e){var a=0;e.getProperty("midas")||($.each(t,function(o,r){parseInt(t[o])==parseInt(e.getProperty("TYPE"))&&a++}),0==a&&t.push(e.getProperty("TYPE")))}),t.length>0&&(a=t.join(","),o="lista="+a),n.map.data.toGeoJson(function(t){for(var a=0;a<t.features.length;a++){var r=t.features[a];r.properties.midas&&e.features.push(r)}var n=JSON.stringify(e);""!==o&&(o+="&"),o+="id="+$("#hIdEmergencia").val()+"&geoJson="+n}),$.post(siteUrl+"visor/saveGeoJson",o,function(e){0==e?bootbox.dialog({title:"Resultado de la operacion",message:"Se ha guardado correctamente",buttons:{danger:{label:"Cerrar",className:"btn-info"}}}):bootbox.dialog({title:"Resultado de la operacion",message:"Error al guardar",buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})})})},$("#ctrlLayers").click(function(){$("#wrapper").toggleClass("toggled");var e=$("#selected_items").val().split(",");$.get(siteUrl+"visor/obtenerCapasDT/id/"+e,function(e){var t="",a=JSON.parse(e);$.each(a,function(e,a){t+="<li id="+a.cap_ia_id+' class="ui-state-default"><div class=checkbox><i class="fa fa-sort"></i><label>&nbsp;&nbsp;&nbsp;'+a.chkbox+'&nbsp;<img src="'+baseUrl+a.arch_c_nombre+'" height="24">&nbsp;'+a.cap_c_nombre+"</label></div></li>"}),$("#sortable").html(t)})}),$("#sortable").sortable({change:function(e,t){}}),$("#sortable").on("sortchange",function(e,t){$("#sortable").sortable("toArray")});var n=this;this.selectCapa=function(e){var t=$("#selected_items").val();if($("#chk_"+e).is(":checked")){if(""==t)var a="";else var a=",";$("#selected_items").val(t+a+e)}else{for(var o=t.split(","),r="",i=0;i<o.length;i++)if(o[i]!=e){if(""==r)var a="";else var a=",";r+=a+o[i]}$("#selected_items").val(r),n.map.data.forEach(function(t){t.getProperty("TYPE")==e&&n.map.data.remove(t)})}n.cargarCapas()},this.quitarFeature=function(e){n.map.data.forEach(function(t){t.getProperty("microtime")==e&&(n.map.data.remove(t),$(".contextmenu").remove())})},this.microtime=function(){var e=(new Date).getTime(),t=parseInt(e,10);return Math.round(1e3*(e-t))/1e3+t},this.showContextMenu=function(e,t){var a,o;a=n.map.getProjection(),$(".contextmenu").remove(),o=document.createElement("div"),o.className="contextmenu",o.innerHTML='<a id="menu1" onclick="VisorMapa.quitarFeature('+t.getProperty("microtime")+')"><div class="context"><i class="fa fa-trash-o"></i>&nbsp;&nbsp;Quitar '+t.getProperty("nombre")+"</div></a>",$(n.map.getDiv()).append(o),n.setMenuXY(e),o.style.visibility="visible"},this.getCanvasXY=function(e){var t=Math.pow(2,n.map.getZoom()),a=new google.maps.LatLng(n.map.getBounds().getNorthEast().lat(),n.map.getBounds().getSouthWest().lng()),o=n.map.getProjection().fromLatLngToPoint(a),r=n.map.getProjection().fromLatLngToPoint(e),i=new google.maps.Point(Math.floor((r.x-o.x)*t),Math.floor((r.y-o.y)*t));return i},this.setMenuXY=function(e){var t=$("#mapa").width(),a=$("#mapa").height(),o=$(".contextmenu").width(),r=$(".contextmenu").height(),i=n.getCanvasXY(e),s=i.x-10,l=i.y-15;o>t-s&&(s-=o),r>a-l&&(l-=r),$(".contextmenu").css("left",s),$(".contextmenu").css("top",l)},this.cargarCapas=function(){if(""!==$("#selected_items").val())for(var e=$("#selected_items").val().split(","),t=0;t<e.length;t++){var a=0;n.map.data.forEach(function(o){o.getProperty("TYPE")==e[t]&&a++}),a>0||$.get(siteUrl+"visor/get_json_capa/id/"+e[t],function(e){for(var t,a=JSON.parse(e),o=JSON.parse(a.json_str),r=a.propiedades.split(","),i=0;i<o.features.length;i++){t=o.features[i];var s="",l="",c="",g="",p=0,m={};switch($.each(t.properties,function(e,t){for(var a=0;a<r.length;a++)e.toLowerCase()==r[a].toLowerCase()&&p++;p>0&&"type"!==e.toLowerCase()&&("comuna"==e.toLowerCase()&&null!==t?c='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+t+"</span></td><tr>":"nombre"!=e.toLowerCase()&&"name"!=e.toLowerCase()||null===t?s+='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+t+"</span></td><tr>":g=t.toUpperCase(),m[e]=t)}),""==g&&(g=a.nombre.toUpperCase()),l="<div class='infoWindow'>",l+="<h4>"+g+"</h4><br>",l+="<div class='well'>",l+="<table>",l+=s,l+=c,l+="</table>",l+="</div>",l+="</div>",m.TYPE=t.properties.TYPE,m.infoWindow=l,m.LAYERNAME=a.nombre.toUpperCase(),t.geometry.type){case"Point":m.icon=a.icono;var d=GeoEncoder.utmToDecimalDegree(parseFloat(t.geometry.coordinates[0]),parseFloat(t.geometry.coordinates[1]),a.geozone),h=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(d[0]),lng:parseFloat(d[1])}),properties:m});n.map.data.add(h);break;case"Polygon":m.fillColor="#999999";for(var d,u=[[]],f=0;f<t.geometry.coordinates[0].length;f++){d=GeoEncoder.utmToDecimalDegree(parseFloat(t.geometry.coordinates[0][f][0]),parseFloat(t.geometry.coordinates[0][f][1]),a.geozone);var y=new google.maps.LatLng(parseFloat(d[0]),parseFloat(d[1]));u[0].push(y)}var v=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(u),properties:m});n.map.data.add(v);break;case"MultiPolygon":m.fillColor="#999999";for(var d,w=0;w<t.geometry.coordinates.length;w++)for(var f=0;f<t.geometry.coordinates[w].length;f++)for(var f=0;f<t.geometry.coordinates[w].length;f++){for(var u=[[]],b=0;b<t.geometry.coordinates[w][f].length;b++){d=GeoEncoder.utmToDecimalDegree(parseFloat(t.geometry.coordinates[w][f][b][0]),parseFloat(t.geometry.coordinates[w][f][b][1]),a.geozone);var y=new google.maps.LatLng(parseFloat(d[0]),parseFloat(d[1]));u[0].push(y)}var C=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(u),properties:m});n.map.data.add(C)}break;case"LineString":m.strokeColor="#0000FF";for(var d,u=[],_=0;_<t.geometry.coordinates.length;_++)d=GeoEncoder.utmToDecimalDegree(parseFloat(t.geometry.coordinates[_][0]),parseFloat(t.geometry.coordinates[_][1]),a.geozone),u.push({lat:parseFloat(d[0]),lng:parseFloat(d[1])});var E=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(u),properties:m});n.map.data.add(E)}}})}};var i=function(){var e=this;this.map.data.forEach(function(t){"INSTALACION"==t.getProperty("type")&&e.map.data.remove(t)})},s=function(e){var t=JSON.parse(e);i.call(this);for(var a=0;a<t.length;a++){var o=t[a];if(o.ins_c_latitud&&o.ins_c_longitud){var r=$("#moldeIns").html();r=r.replace(/__razon_social__/g,o.ins_c_razon_social),r=r.replace(/__nombre_fantasia__/g,o.ins_c_nombre_fantasia),r=r.replace(/__comuna__/g,o.com_c_nombre),r=r.replace(/__region__/g,o.reg_c_nombre),r=r.replace(/__direccion__/g,o.ins_c_nombre_direccion+", "+o.ins_c_numero_direccion+" "+o.ins_c_resto_direccion+" ");var n=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(o.ins_c_latitud),lng:parseFloat(o.ins_c_longitud)}),properties:{type:"INSTALACION",icon:baseUrl+"assets/img/spotlight-poi.png",infoWindow:r,id_maestro:o.ins_ia_id,razon_social:o.ins_c_razon_social,nombre_fantasia:o.ins_c_nombre_fantasia,direccion:o.ins_c_nombre_direccion+", "+o.ins_c_numero_direccion+" "+o.ins_c_resto_direccion,midas:!0}});this.map.data.add(n)}}};this.constructControlIns=function(e){var t=this;$("#tblTiposIns tfoot th").each(function(){var e=$("#tblTiposIns thead th").eq($(this).index()).text();$(this).html('<input type="text" class="form-control" placeholder="'+e+'" />')});var a=$("#tblTiposIns").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},ajax:{url:siteUrl+"instalacion/obtenerJsonDtTipos",type:"GET",async:!0},columns:[{mRender:function(t,a,o){for(var r="",n=0;n<e.length;n++){var i=e[n];if(o.aux_ia_id==i.id_tipo_ins){r='checked="true"';break}}return'<input id="iTipIns'+o.aux_ia_id+'" name="iTipIns[]" value="'+o.aux_ia_id+'" type="checkbox" '+r+"/>"}},{data:"amb_c_nombre"},{data:"aux_c_nombre"}],pagingType:"simple"});$("#tblTiposIns").on("init.dt",function(e,t,o){a.columns().every(function(){var e=this;$("input",this.footer()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})})}),$("#ctrlIns").click(function(){$("#mMaestroInstalaciones").modal("show")}),$("#btnCargarIns").click(function(){var e={};e.idEmergencia=$("#hIdEmergencia").val(),e.tiposIns=[];for(var a=$("input[type='checkbox'][name='iTipIns[]']:checked"),o=0;o<a.length;o++)e.tiposIns.push(a[o].value);$.post(siteUrl+"visor/obtenerJsonInsSegunTipIns",e).done(s.bind(t)),$("#mMaestroInstalaciones").modal("hide")})},this.makeEmergencyDrawManager=function(){var e=this;this.emergencyDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER]},clickable:!1,editable:!0,zIndex:1}),this.emergencyDrawingManager.setMap(null),function(t,a){var o=function(){e.emergencyDrawingManager.setDrawingMode(a),e.emergencyDrawingManager.setMap(e.map);var t=$(this).parents("div").first().find("a.btn");t.removeClass("btn-primary"),t.addClass("btn-success"),$(".ctrlPowerOff").css("display","block"),event.preventDefault(),event.stopPropagation()};$("#"+t).on("click",o)}("ctrlDrawMarker",google.maps.drawing.OverlayType.MARKER),$("#ctrlDrawOFF").click(function(){e.emergencyDrawingManager.setMap(null),e.otherDrawingManager.setMap(null);var t=$(this).parents("div").first().find("a.btn");t.removeClass("btn-success"),t.addClass("btn-primary"),$(".ctrlPowerOff").css("display","none")}),google.maps.event.addListener(this.emergencyDrawingManager,"overlaycomplete",function(t){if(t.type==google.maps.drawing.OverlayType.MARKER){e.emergencyMarker&&(e.map.data.remove(e.emergencyMarker),e.emergencyRadius&&e.map.data.remove(e.emergencyRadius));var a=t.overlay;a.setMap(null);var o=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(a.getPosition()),properties:{type:"LUGAR_EMERGENCIA",icon:baseUrl+"assets/img/spotlight-poi.png",infoWindow:"Lugar de la emergencia",midas:!0}});e.map.data.add(o),e.emergencyMarker=o,$("#mRadioEmergencia").modal("show"),$("#iRadioEmergencia").closest("div").removeClass("has-error")}$("#ctrlDrawOFF").click()}),$("#btnGuardarRadioEmergencia").click(l.bind(this)),$("#mRadioEmergencia").on("shown.bs.modal",function(e){$("#iRadioEmergencia").focus(),$("#iRadioEmergencia").select()}),$("#frmRadioEmergencia").submit(function(){return $("#btnGuardarRadioEmergencia").click(),!1})},this.makeOthersManager=function(){var e=this;this.otherDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON]},clickable:!1,editable:!0,zIndex:1}),this.otherDrawingManager.setMap(null);for(var t=[{id:"ctrlOtherDrawLine",overlay:google.maps.drawing.OverlayType.POLYLINE},{id:"ctrlOtherDrawPolygon",overlay:google.maps.drawing.OverlayType.POLYGON},{id:"ctrlOtherDrawCircle",overlay:google.maps.drawing.OverlayType.CIRCLE},{id:"ctrlOtherDrawRectangle",overlay:google.maps.drawing.OverlayType.RECTANGLE},{id:"ctrlOtherDrawMarker",overlay:google.maps.drawing.OverlayType.MARKER}],a=0;a<t.length;a++)!function(e,t){var a=function(){$("#mOtrosEmergencias").modal("show"),e.otherControlSelected=t};$("#"+t.id).on("click",a)}(this,t[a]);google.maps.event.addListener(this.otherDrawingManager,"overlaycomplete",function(t){var a=t.overlay;a.setMap(null);var o,r,n,i,s=e.microtime();switch(t.type){case google.maps.drawing.OverlayType.POLYLINE:for(o=[],r=0;r<a.getPath().getLength();r++)i=a.getPath().getAt(r),o.push(i);n=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(o),properties:{strokeColor:e.otherControlColor,type:"POLYLINE",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.POLYGON:for(o=[[]],r=0;r<a.getPath().getLength();r++)i=a.getPath().getAt(r),o[0].push(i);n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:e.otherControlColor,type:"POLYGON",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.CIRCLE:o=p(a),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:e.otherControlColor,type:"CIRCLE",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.RECTANGLE:o=[[]];var l=a.getBounds();o[0].push(l.getNorthEast()),o[0].push({lat:l.getSouthWest().lat(),lng:l.getNorthEast().lng()}),o[0].push(l.getSouthWest()),o[0].push({lat:l.getNorthEast().lat(),lng:l.getSouthWest().lng()}),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:e.otherControlColor,type:"RECTANGLE",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.MARKER:var c=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(a.getPosition()),properties:{type:"PUNTO",icon:baseUrl+"assets/img/spotlight-poi-"+e.otherControlDataColor+".png",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}});e.map.data.add(c)}$("#ctrlDrawOFF").click()}),$("#btnGuardarOtrosEmergencia").click(c.bind(this)),$("#botoneraColorControl a").click(function(){$("#botoneraColorControl a i").removeClass("fa fa-check-circle-o"),$(this).find("i").addClass("fa fa-check-circle-o"),$(this).addClass("selected"),e.otherControlColor=Utils.rgb2hex($(this).css("background-color")),e.otherControlDataColor=$(this).attr("data-color")})},this.loadKML=function(e){var t=this,a=new google.maps.KmlLayer({url:e,map:this.map,suppressInfoWindows:!0,preserveViewport:!0});a.addListener("click",function(e){var a=new google.maps.InfoWindow({content:e.featureData.infoWindowHtml});a.setPosition(e.latLng),a.open(t.map)})},this.detectHeight=function(){$(this.canvas).css("height",$("html").height()-$("div.header").height()+"px")},this.makeSearchBox=function(){var e=$("#input-buscador-mapa").get(0),t=new google.maps.places.SearchBox(e),a=this,o=[];this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),this.map.addListener("bounds_changed",function(){t.setBounds(a.map.getBounds())}),t.addListener("places_changed",function(){var e=t.getPlaces();if(0!==e.length){o.forEach(function(e){e.setMap(null)}),o=[];var r=new google.maps.LatLngBounds;e.forEach(function(e){var t={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};o.push(new google.maps.Marker({map:a.map,icon:t,title:e.name,position:e.geometry.location})),e.geometry.viewport?r.union(e.geometry.viewport):r.extend(e.geometry.location)}),a.map.fitBounds(r)}})};var l=function(){var e=$("#iRadioEmergencia").val();if(""===e.trim())return $("#iRadioEmergencia").closest("div").addClass("has-error"),!1;if($("#iRadioEmergencia").val("0"),$("#mRadioEmergencia").modal("hide"),0===e)return!0;var t=new google.maps.Circle({map:null,radius:parseInt(e),fillColor:"#FF0000",center:this.emergencyMarker.getGeometry().get()}),a=p(t),o=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(a),properties:{fillColor:"#FF0000",type:"RADIO_EMERGENCIA",infoWindow:"Radio de la emergencia",midas:!0}});this.map.data.add(o),this.emergencyRadius=o},c=function(){if(!$("#botoneraColorControl a.selected").length)return $("#botoneraColorControl").closest("div").addClass("has-error"),!1;if(!$("#iTituloComponente").val())return $("#iTituloComponente").closest("div").addClass("has-error"),!1;$("#ctrlDraw").addClass("btn-success").removeClass("btn-primary"),this.otherDrawingManager.setDrawingMode(this.otherControlSelected.overlay),this.otherDrawingManager.setMap(this.map),this.otherControlSelected.title=$("#iTituloComponente").val();for(var e=["polygonOptions","circleOptions","rectangleOptions"],t=0;t<e.length;t++)this.otherDrawingManager.set(e[t],{fillColor:this.otherControlColor});this.otherDrawingManager.set("polylineOptions",{strokeColor:this.otherControlColor}),$("#mOtrosEmergencias").modal("hide")},g=360,p=function(e){for(var t=[[]],a=360/g,o=null,r=0;g>r;r++)o=google.maps.geometry.spherical.computeOffset(e.getCenter(),e.getRadius(),a*r),t[0].push(o);return t}}).apply(VisorMapa);