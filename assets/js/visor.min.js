var VisorMapa={map:null,canvas:null,emergencyDrawingManager:null,emergencyMarker:null,emergencyRadius:null,otherDrawingManager:null,otherControlColor:null,otherControlSelected:null,otherFeatures:{circles:[],rectangles:[],polylines:[],polygons:[],markers:[]},otherInfoListener:null,iteracionTemporal:1};(function(){this.init=function(e){this.canvas=$("#mapa").get(0),$(window).resize(this.detectHeight.bind(this));var a={center:new google.maps.LatLng(-33.07,-71.6),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:12},n=$.extend(a,e);this.detectHeight.call(this),this.map=new google.maps.Map(this.canvas,n),this.makeSearchBox.call(this),this.makeEmergencyDrawManager.call(this),this.makeOthersManager.call(this),this.constructControlIns.call(this),this.constructControlLayer.call(this),this.constructControlInfo.call(this)},this.constructControlInfo=function(){var e=this;$("#ctrlInfo").click(function(){var a=this;if(!$(this).hasClass("btn-success")){$(this).removeClass("btn-primary").addClass("btn-success");for(var n=0;n<e.otherFeatures.polygons.length;n++){var o=e.otherFeatures.polygons[n];!function(e,a,n){var o=function(){$("#mInfo").modal("show"),google.maps.event.removeListener(e.otherInfoListener),$(a).removeClass("btn-success").addClass("btn-primary")},r=n.addListener("click",o);e.otherInfoListener=r}(e,a,o)}}})},this.constructControlLayer=function(){var e=this;$("#tblCtrlCapas").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},columns:[{mRender:function(e,a,n){return'<input id="iCtrlLayers'+e+'" name="iCtrlLayers[]" type="checkbox"/>'},sWidth:"30px"},{sType:"string"}],pagingType:"simple",order:[[1,"asc"]]});$("#ctrlLayers").click(function(){$("#mCapas").modal("show")}),$("#btnCargarCapas").click(function(){1==e.iteracionTemporal?(e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=bodegas_quimico"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=quimicas")):2==e.iteracionTemporal&&(e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=hospitales"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=atencion_primaria"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=centros_salud"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=servicentros"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=jardines"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=instalaciones_quimicas"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=liceos_colegios")),e.iteracionTemporal++,$("#mCapas").modal("hide")})};var e=function(){};this.constructControlIns=function(){$("#tblTiposIns tfoot th").each(function(){var e=$("#tblTiposIns thead th").eq($(this).index()).text();$(this).html('<input type="text" class="form-control" placeholder="'+e+'" />')});var a=$("#tblTiposIns").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},ajax:{url:siteUrl+"instalacion/obtenerJsonDtTipos",type:"GET",async:!0},columns:[{mRender:function(e,a,n){return'<input id="iTipIns'+n.aux_ia_id+'" name="iTipIns[]" value="'+n.aux_ia_id+'" type="checkbox"/>'}},{data:"amb_c_nombre"},{data:"aux_c_nombre"}],pagingType:"simple"});$("#tblTiposIns").on("init.dt",function(e,n,o){a.columns().every(function(){var e=this;$("input",this.footer()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})})}),$("#ctrlIns").click(function(){$("#mMaestroInstalaciones").modal("show")}),$("#btnCargarIns").click(function(){var a={};a.idEmergencia=$("#hIdEmergencia").val(),a.tiposIns=[];for(var n=$("input[type='checkbox'][name='iTipIns[]']:checked"),o=0;o<n.length;o++)a.tiposIns.push(n[o].value);$.post(siteUrl+"instalacion/obtenerJsonCoordsTipIns",a).done(e.bind(this)),$("#mMaestroInstalaciones").modal("hide")})},this.makeEmergencyDrawManager=function(){var e=this;this.emergencyDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER]},clickable:!1,editable:!0,zIndex:1}),this.emergencyDrawingManager.setMap(null),function(a,n){var o=function(){e.emergencyDrawingManager.setDrawingMode(n),e.emergencyDrawingManager.setMap(e.map);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-primary"),a.addClass("btn-success"),$(".ctrlPowerOff").css("display","block"),event.preventDefault(),event.stopPropagation()};$("#"+a).on("click",o)}("ctrlDrawMarker",google.maps.drawing.OverlayType.MARKER),$("#ctrlDrawOFF").click(function(){e.emergencyDrawingManager.setMap(null),e.otherDrawingManager.setMap(null);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-success"),a.addClass("btn-primary"),$(".ctrlPowerOff").css("display","none")}),google.maps.event.addListener(this.emergencyDrawingManager,"overlaycomplete",function(a){e.emergencyMarker&&(e.emergencyMarker.setMap(null),e.emergencyRadius&&e.emergencyRadius.setMap(null));var n=new google.maps.InfoWindow({content:"Lugar de la emergencia"});if(a.type==google.maps.drawing.OverlayType.MARKER){var o=a.overlay;e.emergencyMarker=o,e.emergencyMarker.addListener("click",function(a){n.open(e.map,e.emergencyMarker)}),$("#mRadioEmergencia").modal("show"),$("#iRadioEmergencia").closest("div").removeClass("has-error")}$("#ctrlDrawOFF").click()}),$("#btnGuardarRadioEmergencia").click(a.bind(this)),$("#mRadioEmergencia").on("shown.bs.modal",function(e){$("#iRadioEmergencia").focus(),$("#iRadioEmergencia").select()}),$("#frmRadioEmergencia").submit(function(){return $("#btnGuardarRadioEmergencia").click(),!1})},this.makeOthersManager=function(){var e=this;this.otherDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON]},clickable:!1,editable:!0,zIndex:1}),this.otherDrawingManager.setMap(null);for(var a=[{id:"ctrlOtherDrawLine",overlay:google.maps.drawing.OverlayType.POLYLINE},{id:"ctrlOtherDrawPolygon",overlay:google.maps.drawing.OverlayType.POLYGON},{id:"ctrlOtherDrawCircle",overlay:google.maps.drawing.OverlayType.CIRCLE},{id:"ctrlOtherDrawRectangle",overlay:google.maps.drawing.OverlayType.RECTANGLE},{id:"ctrlOtherDrawMarker",overlay:google.maps.drawing.OverlayType.MARKER}],o=0;o<a.length;o++)!function(e,a){var n=function(){$("#mOtrosEmergencias").modal("show"),e.otherControlSelected=a};$("#"+a.id).on("click",n)}(this,a[o]);google.maps.event.addListener(this.otherDrawingManager,"overlaycomplete",function(a){var n=a.overlay,o=new google.maps.InfoWindow({content:e.otherControlSelected.title}),r=[google.maps.drawing.OverlayType.POLYGON,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE];switch(-1!=r.indexOf(a.type)&&n.addListener("click",function(a){o.setPosition(a.latLng),o.open(e.map)}),a.type){case google.maps.drawing.OverlayType.POLYGON:e.otherFeatures.polygons.push(n);break;case google.maps.drawing.OverlayType.CIRCLE:e.otherFeatures.circles.push(n);break;case google.maps.drawing.OverlayType.POLYLINE:e.otherFeatures.polylines.push(n);break;case google.maps.drawing.OverlayType.RECTANGLE:e.otherFeatures.rectangles.push(n);break;case google.maps.drawing.OverlayType.MARKER:e.otherFeatures.markers.push(n)}$("#ctrlDrawOFF").click()}),$("#btnGuardarOtrosEmergencia").click(n.bind(this)),$("#botoneraColorControl a").click(function(){$("#botoneraColorControl a i").removeClass("fa fa-check-circle-o"),$(this).find("i").addClass("fa fa-check-circle-o"),$(this).addClass("selected"),e.otherControlColor=Utils.rgb2hex($(this).css("background-color"))})},this.loadKML=function(e){var a=this,n=new google.maps.KmlLayer({url:e,map:this.map,suppressInfoWindows:!0,preserveViewport:!0});n.addListener("click",function(e){var n=new google.maps.InfoWindow({content:e.featureData.infoWindowHtml});n.setPosition(e.latLng),n.open(a.map)})},this.detectHeight=function(){$(this.canvas).css("height",$("html").height()-$("div.header").height()+"px")},this.makeSearchBox=function(){var e=$("#input-buscador-mapa").get(0),a=new google.maps.places.SearchBox(e),n=this,o=[];this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),this.map.addListener("bounds_changed",function(){a.setBounds(n.map.getBounds())}),a.addListener("places_changed",function(){var e=a.getPlaces();if(0!==e.length){o.forEach(function(e){e.setMap(null)}),o=[];var r=new google.maps.LatLngBounds;e.forEach(function(e){var a={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};o.push(new google.maps.Marker({map:n.map,icon:a,title:e.name,position:e.geometry.location})),e.geometry.viewport?r.union(e.geometry.viewport):r.extend(e.geometry.location)}),n.map.fitBounds(r)}})};var a=function(){var e=$("#iRadioEmergencia").val();if(""===e.trim())return $("#iRadioEmergencia").closest("div").addClass("has-error"),!1;if($("#iRadioEmergencia").val("0"),$("#mRadioEmergencia").modal("hide"),0===e)return!0;this.emergencyRadius=new google.maps.Circle({map:this.map,radius:parseInt(e),fillColor:"#FF0000",center:this.emergencyMarker.getPosition()});var a=new google.maps.InfoWindow({content:"Radio de la emergencia"});this.emergencyRadius.addListener("click",function(e){a.setPosition(e.latLng),a.open(this.map)})},n=function(){if(!$("#botoneraColorControl a.selected").length)return $("#botoneraColorControl").closest("div").addClass("has-error"),!1;if(!$("#iTituloComponente").val())return $("#iTituloComponente").closest("div").addClass("has-error"),!1;$("#ctrlDraw").addClass("btn-success").removeClass("btn-primary"),this.otherDrawingManager.setDrawingMode(this.otherControlSelected.overlay),this.otherDrawingManager.setMap(this.map),this.otherControlSelected.title=$("#iTituloComponente").val();for(var e=["polygonOptions","circleOptions","rectangleOptions"],a=0;a<e.length;a++)this.otherDrawingManager.set(e[a],{fillColor:this.otherControlColor});this.otherDrawingManager.set("polylineOptions",{strokeColor:this.otherControlColor}),$("#mOtrosEmergencias").modal("hide")}}).apply(VisorMapa);