var VisorMapa={map:null,canvas:null,emergencyMarker:null,emergencyRadius:null,emergencyDrawingManager:null,otherDrawingManager:null,otherControlColor:null,otherControlDataColor:null,otherControlSelected:null,otherInfoListener:null};(function(){var e=null;this.init=function(e){this.opciones=e,$.get(siteUrl+"emergencia/obtenerJsonLimitesVisor/id/"+$("#hIdEmergencia").val()).done(this.makeMap.bind(this))},this.makeMap=function(a){for(var o=this,t=JSON.parse(a),r=new google.maps.LatLngBounds,n=0;n<t.length;n++){var i=t[n];if(i.com_c_xmin&&i.com_c_ymin&&i.com_c_xmax&&i.com_c_ymax){var s=GeoEncoder.utmToDecimalDegree(parseFloat(i.com_c_xmin),parseFloat(i.com_c_ymin),i.com_c_geozone);r.extend(new google.maps.LatLng(s[0],s[1])),s=GeoEncoder.utmToDecimalDegree(parseFloat(i.com_c_xmax),parseFloat(i.com_c_ymax),i.com_c_geozone),r.extend(new google.maps.LatLng(s[0],s[1]))}}this.canvas=$("#mapa").get(0),$(window).resize(this.detectHeight.bind(this));var l={center:new google.maps.LatLng(-33.07,-71.6),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:12},g=$.extend(l,e);this.detectHeight.call(this),this.map=new google.maps.Map(this.canvas,g),this.map.fitBounds(r),this.makeSearchBox.call(this),this.makeEmergencyDrawManager.call(this),this.makeOthersManager.call(this),this.constructControlIns.call(this),this.constructControlLayer.call(this),this.constructControlInfo.call(this),this.map.data.setStyle(function(e){var a=null,o={};return e.getProperty("fillColor")&&(a=e.getProperty("color"),o.fillOpacity=.3,o.fillColor=e.getProperty("fillColor")),e.getProperty("strokeColor")&&(o.strokeColor=e.getProperty("strokeColor")),e.getProperty("icon")&&(o.icon=e.getProperty("icon")),o}),this.map.data.addListener("click",function(e){var a=new google.maps.InfoWindow({content:e.feature.getProperty("infoWindow"),position:e.latLng});e.feature.getProperty("infoWindow")&&a.open(o.map)})},this.constructControlInfo=function(){var e=this;$("#ctrlInfo").click(function(){var a=this;if(!$(this).hasClass("btn-success")){$(this).removeClass("btn-primary").addClass("btn-success");for(var o=0;o<e.otherFeatures.polygons.length;o++){var t=e.otherFeatures.polygons[o];!function(e,a,o){var t=function(){$("#mInfo").modal("show"),google.maps.event.removeListener(e.otherInfoListener),$(a).removeClass("btn-success").addClass("btn-primary")},r=o.addListener("click",t);e.otherInfoListener=r}(e,a,t)}}})},this.constructControlLayer=function(){var e=this;$("#tblCtrlCapas").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},columns:[{mRender:function(e,a,o){return'<input id="iCtrlLayers'+e+'" name="iCtrlLayers[]" type="checkbox"/>'},sWidth:"30px"},{sType:"string"}],pagingType:"simple",order:[[1,"asc"]]});$("#ctrlLayers").click(function(){$("#mCapas").modal("show")}),$("#btnCargarCapas").click(function(){1==e.iteracionTemporal?(e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=bodegas_quimico"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=quimicas")):2==e.iteracionTemporal&&(e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=hospitales"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=atencion_primaria"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=centros_salud"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=servicentros"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=jardines"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=instalaciones_quimicas"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=liceos_colegios")),e.iteracionTemporal++,$("#mCapas").modal("hide")})};var a=function(e){for(var a=JSON.parse(e),o=0;o<a.length;o++){var t=a[o];if(t.ins_c_latitud&&t.ins_c_longitud){new google.maps.Marker({position:{lat:parseFloat(t.ins_c_latitud),lng:parseFloat(t.ins_c_longitud)},map:this.map,title:t.ins_c_razon_social+" - "+t.ins_c_nombre_fantasia})}}};this.constructControlIns=function(){var e=this;$("#tblTiposIns tfoot th").each(function(){var e=$("#tblTiposIns thead th").eq($(this).index()).text();$(this).html('<input type="text" class="form-control" placeholder="'+e+'" />')});var o=$("#tblTiposIns").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},ajax:{url:siteUrl+"instalacion/obtenerJsonDtTipos",type:"GET",async:!0},columns:[{mRender:function(e,a,o){return'<input id="iTipIns'+o.aux_ia_id+'" name="iTipIns[]" value="'+o.aux_ia_id+'" type="checkbox"/>'}},{data:"amb_c_nombre"},{data:"aux_c_nombre"}],pagingType:"simple"});$("#tblTiposIns").on("init.dt",function(e,a,t){o.columns().every(function(){var e=this;$("input",this.footer()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})})}),$("#ctrlIns").click(function(){$("#mMaestroInstalaciones").modal("show")}),$("#btnCargarIns").click(function(){var o={};o.idEmergencia=$("#hIdEmergencia").val(),o.tiposIns=[];for(var t=$("input[type='checkbox'][name='iTipIns[]']:checked"),r=0;r<t.length;r++)o.tiposIns.push(t[r].value);$.post(siteUrl+"instalacion/obtenerJsonInsSegunTipIns",o).done(a.bind(e)),$("#mMaestroInstalaciones").modal("hide")})},this.makeEmergencyDrawManager=function(){var e=this;this.emergencyDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER]},clickable:!1,editable:!0,zIndex:1}),this.emergencyDrawingManager.setMap(null),function(a,o){var t=function(){e.emergencyDrawingManager.setDrawingMode(o),e.emergencyDrawingManager.setMap(e.map);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-primary"),a.addClass("btn-success"),$(".ctrlPowerOff").css("display","block"),event.preventDefault(),event.stopPropagation()};$("#"+a).on("click",t)}("ctrlDrawMarker",google.maps.drawing.OverlayType.MARKER),$("#ctrlDrawOFF").click(function(){e.emergencyDrawingManager.setMap(null),e.otherDrawingManager.setMap(null);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-success"),a.addClass("btn-primary"),$(".ctrlPowerOff").css("display","none")}),google.maps.event.addListener(this.emergencyDrawingManager,"overlaycomplete",function(a){if(a.type==google.maps.drawing.OverlayType.MARKER){e.emergencyMarker&&(e.map.data.remove(e.emergencyMarker),e.emergencyRadius&&e.map.data.remove(e.emergencyRadius));var o=a.overlay;o.setMap(null);var t=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(o.getPosition()),properties:{type:"LUGAR_EMERGENCIA",icon:"https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi.png",infoWindow:"Lugar de la emergencia"}});e.map.data.add(t),e.emergencyMarker=t,$("#mRadioEmergencia").modal("show"),$("#iRadioEmergencia").closest("div").removeClass("has-error")}$("#ctrlDrawOFF").click()}),$("#btnGuardarRadioEmergencia").click(o.bind(this)),$("#mRadioEmergencia").on("shown.bs.modal",function(e){$("#iRadioEmergencia").focus(),$("#iRadioEmergencia").select()}),$("#frmRadioEmergencia").submit(function(){return $("#btnGuardarRadioEmergencia").click(),!1})},this.makeOthersManager=function(){var e=this;this.otherDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON]},clickable:!1,editable:!0,zIndex:1}),this.otherDrawingManager.setMap(null);for(var a=[{id:"ctrlOtherDrawLine",overlay:google.maps.drawing.OverlayType.POLYLINE},{id:"ctrlOtherDrawPolygon",overlay:google.maps.drawing.OverlayType.POLYGON},{id:"ctrlOtherDrawCircle",overlay:google.maps.drawing.OverlayType.CIRCLE},{id:"ctrlOtherDrawRectangle",overlay:google.maps.drawing.OverlayType.RECTANGLE},{id:"ctrlOtherDrawMarker",overlay:google.maps.drawing.OverlayType.MARKER}],o=0;o<a.length;o++)!function(e,a){var o=function(){$("#mOtrosEmergencias").modal("show"),e.otherControlSelected=a};$("#"+a.id).on("click",o)}(this,a[o]);google.maps.event.addListener(this.otherDrawingManager,"overlaycomplete",function(a){var o=a.overlay;switch(o.setMap(null),a.type){case google.maps.drawing.OverlayType.POLYLINE:for(var t=[],r=0;r<o.getPath().getLength();r++){var i=o.getPath().getAt(r);t.push(i)}var s=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(t),properties:{strokeColor:e.otherControlColor,type:"POLYLINE",infoWindow:e.otherControlSelected.title}});e.map.data.add(s);break;case google.maps.drawing.OverlayType.POLYGON:for(var t=[[]],r=0;r<o.getPath().getLength();r++){var i=o.getPath().getAt(r);t[0].push(i)}var s=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(t),properties:{fillColor:e.otherControlColor,type:"POLYGON",infoWindow:e.otherControlSelected.title}});e.map.data.add(s);break;case google.maps.drawing.OverlayType.CIRCLE:var t=n(o),s=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(t),properties:{fillColor:e.otherControlColor,type:"CIRCLE",infoWindow:e.otherControlSelected.title}});e.map.data.add(s);break;case google.maps.drawing.OverlayType.RECTANGLE:var t=[];t.push([]);var l=o.getBounds();t[0].push(l.getNorthEast()),t[0].push({lat:l.getSouthWest().lat(),lng:l.getNorthEast().lng()}),t[0].push(l.getSouthWest()),t[0].push({lat:l.getNorthEast().lat(),lng:l.getSouthWest().lng()});var s=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(t),properties:{fillColor:e.otherControlColor,type:"RECTANGLE",infoWindow:e.otherControlSelected.title}});e.map.data.add(s);break;case google.maps.drawing.OverlayType.MARKER:var g=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(o.getPosition()),properties:{type:"PUNTO",icon:baseUrl+"assets/img/spotlight-poi-"+e.otherControlDataColor+".png",infoWindow:e.otherControlSelected.title}});e.map.data.add(g)}$("#ctrlDrawOFF").click()}),$("#btnGuardarOtrosEmergencia").click(t.bind(this)),$("#botoneraColorControl a").click(function(){$("#botoneraColorControl a i").removeClass("fa fa-check-circle-o"),$(this).find("i").addClass("fa fa-check-circle-o"),$(this).addClass("selected"),e.otherControlColor=Utils.rgb2hex($(this).css("background-color")),e.otherControlDataColor=$(this).attr("data-color")})},this.loadKML=function(e){var a=this,o=new google.maps.KmlLayer({url:e,map:this.map,suppressInfoWindows:!0,preserveViewport:!0});o.addListener("click",function(e){var o=new google.maps.InfoWindow({content:e.featureData.infoWindowHtml});o.setPosition(e.latLng),o.open(a.map)})},this.detectHeight=function(){$(this.canvas).css("height",$("html").height()-$("div.header").height()+"px")},this.makeSearchBox=function(){var e=$("#input-buscador-mapa").get(0),a=new google.maps.places.SearchBox(e),o=this,t=[];this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),this.map.addListener("bounds_changed",function(){a.setBounds(o.map.getBounds())}),a.addListener("places_changed",function(){var e=a.getPlaces();if(0!==e.length){t.forEach(function(e){e.setMap(null)}),t=[];var r=new google.maps.LatLngBounds;e.forEach(function(e){var a={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};t.push(new google.maps.Marker({map:o.map,icon:a,title:e.name,position:e.geometry.location})),e.geometry.viewport?r.union(e.geometry.viewport):r.extend(e.geometry.location)}),o.map.fitBounds(r)}})};var o=function(){var e=$("#iRadioEmergencia").val();if(""===e.trim())return $("#iRadioEmergencia").closest("div").addClass("has-error"),!1;if($("#iRadioEmergencia").val("0"),$("#mRadioEmergencia").modal("hide"),0===e)return!0;var a=new google.maps.Circle({map:null,radius:parseInt(e),fillColor:"#FF0000",center:this.emergencyMarker.getGeometry().get()}),o=n(a),t=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:"#FF0000",type:"RADIO_EMERGENCIA",infoWindow:"Radio de la emergencia"}});this.map.data.add(t),this.emergencyRadius=t},t=function(){if(!$("#botoneraColorControl a.selected").length)return $("#botoneraColorControl").closest("div").addClass("has-error"),!1;if(!$("#iTituloComponente").val())return $("#iTituloComponente").closest("div").addClass("has-error"),!1;$("#ctrlDraw").addClass("btn-success").removeClass("btn-primary"),this.otherDrawingManager.setDrawingMode(this.otherControlSelected.overlay),this.otherDrawingManager.setMap(this.map),this.otherControlSelected.title=$("#iTituloComponente").val();for(var e=["polygonOptions","circleOptions","rectangleOptions"],a=0;a<e.length;a++)this.otherDrawingManager.set(e[a],{fillColor:this.otherControlColor});this.otherDrawingManager.set("polylineOptions",{strokeColor:this.otherControlColor}),$("#mOtrosEmergencias").modal("hide")},r=1800,n=function(e){for(var a=[[]],o=360/r,t=null,n=0;r>n;n++)t=google.maps.geometry.spherical.computeOffset(e.getCenter(),e.getRadius(),o*n),a[0].push(t);return a}}).apply(VisorMapa);