var VisorMapa={map:null,canvas:null,emergencyMarker:null,emergencyRadius:null,emergencyDrawingManager:null,referenciaMarker:null,otherDrawingManager:null,otherControlColor:null,otherControlDataColor:null,otherControlSelected:null,otherStatusInfoControl:"off",centro:null};(function(){var e,a=null;this.init=function(e){this.opciones=e,$.get(siteUrl+"visor/obtenerJsonEmergenciaVisor/id/"+$("#hIdEmergencia").val()).done(this.makeMap.bind(this))},google.maps.Map.prototype.clearMarkers=function(){e&&e.close()},this.makeMap=function(t){for(var r=!1,n=!1,i=this,s=JSON.parse(t),l=new google.maps.LatLngBounds,c=0;c<s.coordinates.length;c++){var g=s.coordinates[c];if(g.com_c_xmin&&g.com_c_ymin&&g.com_c_xmax&&g.com_c_ymax){var p=GeoEncoder.utmToDecimalDegree(parseFloat(g.com_c_xmin),parseFloat(g.com_c_ymin),g.com_c_geozone);l.extend(new google.maps.LatLng(p[0],p[1])),p=GeoEncoder.utmToDecimalDegree(parseFloat(g.com_c_xmax),parseFloat(g.com_c_ymax),g.com_c_geozone),l.extend(new google.maps.LatLng(p[0],p[1]))}}this.canvas=$("#mapa").get(0),$(window).resize(this.detectHeight.bind(this));var m={center:new google.maps.LatLng(-33.07,-71.6),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:12},d=$.extend(m,a);this.detectHeight.call(this),this.map=new google.maps.Map(this.canvas,d),this.map.fitBounds(l),this.makeSearchBox.call(this),this.makeEmergencyDrawManager.call(this),this.makeOthersManager.call(this),this.constructControlIns.call(this,s.facilities),this.constructControlInfo.call(this),this.constructControlSave.call(this),this.map.data.setStyle(function(e){var a=null,t={};return e.getProperty("fillColor")&&(a=e.getProperty("color"),t.fillOpacity=.3,t.fillColor=e.getProperty("fillColor")),e.getProperty("strokeColor")&&(t.strokeColor=e.getProperty("strokeColor")),e.getProperty("icon")&&(t.icon=e.getProperty("icon")),t}),this.map.data.addListener("click",function(a){return"on"==i.otherStatusInfoControl?o.call(i,a):void(a.feature.getProperty("infoWindow")&&(e&&e.close(),e=new google.maps.InfoWindow({content:a.feature.getProperty("infoWindow"),position:a.latLng}),e.open(i.map)))}),this.map.addListener("zoom_changed",function(e){$(".contextmenu").remove()}),this.map.addListener("rightclick",function(e){$(".contextmenu").remove()}),this.map.addListener("click",function(e){$(".contextmenu").remove()}),this.map.addListener("dblclick",function(e){$(".contextmenu").remove()}),this.map.data.addListener("rightclick",function(e){e.feature.getProperty("microtime")&&i.showContextMenu(e.latLng,e.feature)});var h=JSON.parse(s.referencia);if(h.ref_lat&&h.ref_lng&&h.geozone&&(n=!0,i.drawReferencia(h.ref_lat,h.ref_lng,h.geozone),this.centro=i.referenciaMarker.getGeometry().get()),s.geojson&&(r=!0,i.loadJson(s.geojson)),s.capas&&i.cargarCapas(s.capas),!r&&!n)for(var l=new google.maps.LatLngBounds,c=0;c<s.coordinates.length;c++){var g=s.coordinates[c];if(g.com_c_xmin&&g.com_c_ymin&&g.com_c_xmax&&g.com_c_ymax){var p=GeoEncoder.utmToDecimalDegree(parseFloat(g.com_c_xmin),parseFloat(g.com_c_ymin),g.com_c_geozone);l.extend(new google.maps.LatLng(p[0],p[1])),p=GeoEncoder.utmToDecimalDegree(parseFloat(g.com_c_xmax),parseFloat(g.com_c_ymax),g.com_c_geozone),l.extend(new google.maps.LatLng(p[0],p[1])),this.map.fitBounds(l)}}};var t=this;this.loadJson=function(e){t.map.data.loadGeoJson(e,null,function(e){for(var a=0;a<e.length;a++){var o=e[a];if("LUGAR_EMERGENCIA"==o.getProperty("type")){t.map.data.remove(t.referenciaMarker),t.emergencyMarker=o;var r=new google.maps.LatLng(parseFloat(o.j.j.lat()),parseFloat(o.j.j.lng()));t.centro=r}else"RADIO_EMERGENCIA"==o.getProperty("type")&&(t.emergencyRadius=o)}t.map.setCenter(t.centro),t.map.setZoom(15)})},this.drawReferencia=function(e,a,t){var o=GeoEncoder.utmToDecimalDegree(parseFloat(a),parseFloat(e),t),r=new google.maps.LatLng(parseFloat(o[0]),parseFloat(o[1])),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(r),properties:{type:"REFERENCIA",icon:baseUrl+"assets/img/referencia.png",infoWindow:"Lugar de referencia alarma",nombre:"Lugar de referencia alarma"}});this.map.data.add(n),this.referenciaMarker=n};var o=function(e){if("Polygon"!=e.feature.getGeometry().getType())return null;var a,t,o=r.call(this),i=[],s=new google.maps.Polygon({map:null});for(s.setPaths(e.feature.getGeometry().getAt(0).getArray()),t=0;t<o.length;t++)a=o[t],"Point"==a.getGeometry().getType()&&"LUGAR_EMERGENCIA"!=a.getProperty("type")&&google.maps.geometry.poly.containsLocation(a.getGeometry().get(),s)&&i.push(a);if(0==i.length)return null;var l,c,g,a,p,m,d,h=null,u={},f=["midas","icon","infoWindow","type","TYPE","LAYERNAME","microtime"],y=$("#mInfoContent");u.tipo=[],u.layername=[],u.cols=[];var v;for(t=0;t<i.length;t++){a=i[t],g=0;var h=a;$.each(u.tipo,function(e,a){(h.getProperty("type")==a||h.getProperty("TYPE")==a)&&g++}),0==g&&(v=[],null!=h.getProperty("TYPE")?(u.tipo.push(h.getProperty("TYPE")),u.layername.push(h.getProperty("LAYERNAME")),$.each(n(h),function(e){u.cols.hasOwnProperty(e)||(c={},c.mData=e,c.sTitle=e,-1!=f.indexOf(e)&&(c.bVisible=!1),v.push(c))}),u.cols.push(v)):null!=h.getProperty("type")&&(u.tipo.push(h.getProperty("type")),u.layername.push(h.getProperty("type")),$.each(n(h),function(e){u.cols.hasOwnProperty(e)||(c={},c.mData=e,c.sTitle=e,-1!=f.indexOf(e)&&(c.bVisible=!1),v.push(c))}),u.cols.push(v)))}return y.html(""),y.append('<ul id="ul-tabs" class="nav nav-tabs"></ul>'),$("#ul-tabs").after('<div id="tab-content" class="tab-content"></div>'),$.each(u.tipo,function(e,t){p=u.tipo[e],d=u.layername[e],l={},l.data=[];for(var o=0;o<i.length;o++)a=i[o],(a.getProperty("type")==p||a.getProperty("TYPE")==p)&&l.data.push(n(a));m=0==e?"active":"",$("#ul-tabs").append("<li class="+m+'><a href="#tab'+e+'" data-toggle="tab">'+d+"</a></li>"),$("#tab-content").append("<div class='tab-pane "+m+"' id='tab"+e+"' style='overflow:hidden;'><div id='div_tab_"+e+"' class='col-xs-12 table-responsive'></div></div>"),$("#div_tab_"+e).append("<table id=table_"+e+' class="table table-bordered table-striped"><thead></thead><tbody></tbody><tfoot></tfoot></table>'),$("#table_"+e).DataTable({columns:u.cols[e],data:l.data,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"}})}),$("#mInfo").modal("show"),$("#ctrlInfo").click(),null},r=function(){var e=[];return this.map.data.forEach(function(a){e.push(a)}),e},n=function(e){var a={};return e.forEachProperty(function(e,t){a[t]=e}),a};this.constructControlInfo=function(){var e=this;$("#ctrlInfo").click(function(){return $(this).hasClass("btn-success")?($(this).removeClass("btn-success").addClass("btn-primary"),void(e.otherStatusInfoControl="off")):($(this).removeClass("btn-primary").addClass("btn-success"),void(e.otherStatusInfoControl="on"))})};var t=this;this.constructControlSave=function(){$("#ctrlSave").click(function(){var e={type:"FeatureCollection",features:[]},a=[],o="",r="";t.map.data.forEach(function(e){var t=0;e.getProperty("midas")||"REFERENCIA"===e.getProperty("type")||($.each(a,function(o,r){parseInt(a[o])==parseInt(e.getProperty("TYPE"))&&t++}),0==t&&a.push(e.getProperty("TYPE")))}),a.length>0&&(o=a.join(","),r="lista="+o),t.map.data.toGeoJson(function(a){for(var t=0;t<a.features.length;t++){var o=a.features[t];o.properties.midas&&e.features.push(o)}var n=JSON.stringify(e);""!==r&&(r+="&"),r+="id="+$("#hIdEmergencia").val()+"&geoJson="+n}),$.post(siteUrl+"visor/saveGeoJson",r,function(e){0==e?bootbox.dialog({title:"Resultado de la operacion",message:"Se ha guardado correctamente",buttons:{danger:{label:"Cerrar",className:"btn-info"}}}):bootbox.dialog({title:"Resultado de la operacion",message:"Error al guardar",buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})})})},$("#ctrlLayers").click(function(){var e=$("#selected_items").val().split(",");$.get(siteUrl+"visor/obtenerCapasDT/eme_ia_id/"+$("#hIdEmergencia").val()+"/id/"+e,function(e){var a="",t=JSON.parse(e);return 0==t.length?(bootbox.dialog({title:"Resultado de la operacion",message:"no hay capas de las comunas de la emergencia",buttons:{danger:{label:"Cerrar",className:"btn-danger"}}}),!1):($("#wrapper").toggleClass("toggled"),$.each(t,function(e,t){a+="<li id="+t.cap_ia_id+' class="ui-state-default"><div class=checkbox><i class="fa fa-sort"></i><label>&nbsp;&nbsp;&nbsp;'+t.chkbox+'&nbsp;<img src="'+baseUrl+t.arch_c_nombre+'" height="24">&nbsp;'+t.cap_c_nombre+"</label></div></li>"}),void $("#sortable").html(a))})}),$("#sortable").sortable({change:function(e,a){}}),$("#sortable").on("sortchange",function(e,a){$("#sortable").sortable("toArray")});var t=this;this.selectCapa=function(e){var a=$("#selected_items").val();if($("#chk_"+e).is(":checked")){if(""==a)var o="";else var o=",";$("#selected_items").val(a+o+e)}else{for(var r=a.split(","),n="",i=0;i<r.length;i++)if(r[i]!=e){if(""==n)var o="";else var o=",";n+=o+r[i]}$("#selected_items").val(n),t.map.data.forEach(function(a){a.getProperty("TYPE")==e&&t.map.data.remove(a)})}t.cargarCapas()},this.quitarFeature=function(e){t.map.data.forEach(function(a){a.getProperty("microtime")==e&&("LUGAR_EMERGENCIA"==a.getProperty("type")||"RADIO_EMERGENCIA"==a.getProperty("type")?(t.map.data.remove(t.emergencyRadius),t.map.data.remove(t.emergencyMarker),t.map.data.add(t.referenciaMarker)):t.map.data.remove(a),$(".contextmenu").remove())})},this.microtime=function(){var e=(new Date).getTime(),a=parseInt(e,10);return Math.round(1e3*(e-a))/1e3+a},this.showContextMenu=function(e,a){var o,r;o=t.map.getProjection(),$(".contextmenu").remove(),r=document.createElement("div"),r.className="contextmenu",r.innerHTML='<a id="menu1" onclick="VisorMapa.quitarFeature('+a.getProperty("microtime")+')"><div class="context"><i class="fa fa-trash-o"></i>&nbsp;&nbsp;Quitar '+a.getProperty("nombre")+"</div></a>",$(t.map.getDiv()).append(r),t.setMenuXY(e),r.style.visibility="visible"},this.getCanvasXY=function(e){var a=Math.pow(2,t.map.getZoom()),o=new google.maps.LatLng(t.map.getBounds().getNorthEast().lat(),t.map.getBounds().getSouthWest().lng()),r=t.map.getProjection().fromLatLngToPoint(o),n=t.map.getProjection().fromLatLngToPoint(e),i=new google.maps.Point(Math.floor((n.x-r.x)*a),Math.floor((n.y-r.y)*a));return i},this.setMenuXY=function(e){var a=$("#mapa").width(),o=$("#mapa").height(),r=$(".contextmenu").width(),n=$(".contextmenu").height(),i=t.getCanvasXY(e),s=i.x-10,l=i.y-15;r>a-s&&(s-=r),n>o-l&&(l-=n),$(".contextmenu").css("left",s),$(".contextmenu").css("top",l)},this.cargarCapas=function(){if(""!==$("#selected_items").val())for(var e=$("#selected_items").val().split(","),a=0;a<e.length;a++){var o=0;t.map.data.forEach(function(t){t.getProperty("TYPE")==e[a]&&o++}),o>0||$.get(siteUrl+"visor/get_json_capa/id/"+e[a],function(e){for(var a,o=JSON.parse(e),r=JSON.parse(o.json_str),n=o.propiedades.split(","),i=0;i<r.features.length;i++){a=r.features[i];var s="",l="",c="",g="",p=0,m={};switch($.each(a.properties,function(e,a){for(var t=0;t<n.length;t++)e.toLowerCase()==n[t].toLowerCase()&&p++;p>0&&"type"!==e.toLowerCase()&&("comuna"==e.toLowerCase()&&null!==a?c='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+a+"</span></td><tr>":"nombre"!=e.toLowerCase()&&"name"!=e.toLowerCase()||null===a?s+='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+a+"</span></td><tr>":g=a.toUpperCase(),m[e]=a)}),""==g&&(g=o.nombre.toUpperCase()),l="<div class='infoWindow'>",l+="<h4>"+g+"</h4><br>",l+="<div class='well'>",l+="<table>",l+=s,l+=c,l+="</table>",l+="</div>",l+="</div>",m.TYPE=a.properties.TYPE,m.infoWindow=l,m.LAYERNAME=o.nombre.toUpperCase(),a.geometry.type){case"Point":m.icon=o.icono;var d=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[0]),parseFloat(a.geometry.coordinates[1]),o.geozone),h=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(d[0]),lng:parseFloat(d[1])}),properties:m});t.map.data.add(h);break;case"Polygon":m.fillColor="#999999";for(var d,u=[[]],f=0;f<a.geometry.coordinates[0].length;f++){d=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[0][f][0]),parseFloat(a.geometry.coordinates[0][f][1]),o.geozone);var y=new google.maps.LatLng(parseFloat(d[0]),parseFloat(d[1]));u[0].push(y)}var v=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(u),properties:m});t.map.data.add(v);break;case"MultiPolygon":m.fillColor="#999999";for(var d,w=0;w<a.geometry.coordinates.length;w++)for(var f=0;f<a.geometry.coordinates[w].length;f++)for(var f=0;f<a.geometry.coordinates[w].length;f++){for(var u=[[]],_=0;_<a.geometry.coordinates[w][f].length;_++){d=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[w][f][_][0]),parseFloat(a.geometry.coordinates[w][f][_][1]),o.geozone);var y=new google.maps.LatLng(parseFloat(d[0]),parseFloat(d[1]));u[0].push(y)}var b=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(u),properties:m});t.map.data.add(b)}break;case"LineString":m.strokeColor="#0000FF";for(var d,u=[],C=0;C<a.geometry.coordinates.length;C++)d=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[C][0]),parseFloat(a.geometry.coordinates[C][1]),o.geozone),u.push({lat:parseFloat(d[0]),lng:parseFloat(d[1])});var E=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(u),properties:m});t.map.data.add(E)}}})}};var i=function(){var e=this;this.map.data.forEach(function(a){"INSTALACION"==a.getProperty("type")&&e.map.data.remove(a)})},s=function(e){var a=JSON.parse(e);i.call(this);for(var t=0;t<a.length;t++){var o=a[t];if(o.ins_c_latitud&&o.ins_c_longitud){var r=$("#moldeIns").html();r=r.replace(/__razon_social__/g,o.ins_c_razon_social),r=r.replace(/__nombre_fantasia__/g,o.ins_c_nombre_fantasia),r=r.replace(/__comuna__/g,o.com_c_nombre),r=r.replace(/__region__/g,o.reg_c_nombre),r=r.replace(/__direccion__/g,o.ins_c_nombre_direccion+", "+o.ins_c_numero_direccion+" "+o.ins_c_resto_direccion+" ");var n=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(o.ins_c_latitud),lng:parseFloat(o.ins_c_longitud)}),properties:{type:"INSTALACION",icon:baseUrl+"assets/img/spotlight-poi.png",infoWindow:r,id_maestro:o.ins_ia_id,razon_social:o.ins_c_razon_social,nombre_fantasia:o.ins_c_nombre_fantasia,direccion:o.ins_c_nombre_direccion+", "+o.ins_c_numero_direccion+" "+o.ins_c_resto_direccion,midas:!0}});this.map.data.add(n)}}};this.constructControlIns=function(e){var a=this;$("#tblTiposIns tfoot th").each(function(){var e=$("#tblTiposIns thead th").eq($(this).index()).text();$(this).html('<input type="text" class="form-control" placeholder="'+e+'" />')});var t=$("#tblTiposIns").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},ajax:{url:siteUrl+"instalacion/obtenerJsonDtTipos",type:"GET",async:!0},columns:[{mRender:function(a,t,o){for(var r="",n=0;n<e.length;n++){var i=e[n];if(o.aux_ia_id==i.id_tipo_ins){r='checked="true"';break}}return'<input id="iTipIns'+o.aux_ia_id+'" name="iTipIns[]" value="'+o.aux_ia_id+'" type="checkbox" '+r+"/>"}},{data:"amb_c_nombre"},{data:"aux_c_nombre"}],pagingType:"simple"});$("#tblTiposIns").on("init.dt",function(e,a,o){t.columns().every(function(){var e=this;$("input",this.footer()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})})}),$("#ctrlIns").click(function(){$("#mMaestroInstalaciones").modal("show")}),$("#btnCargarIns").click(function(){var e={};e.idEmergencia=$("#hIdEmergencia").val(),e.tiposIns=[];for(var t=$("input[type='checkbox'][name='iTipIns[]']:checked"),o=0;o<t.length;o++)e.tiposIns.push(t[o].value);$.post(siteUrl+"visor/obtenerJsonInsSegunTipIns",e).done(s.bind(a)),$("#mMaestroInstalaciones").modal("hide")})},this.makeEmergencyDrawManager=function(){var e=this;this.emergencyDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER]},clickable:!1,editable:!0,zIndex:1}),this.emergencyDrawingManager.setMap(null),function(a,t){var o=function(){e.emergencyDrawingManager.setDrawingMode(t),e.emergencyDrawingManager.setMap(e.map);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-primary"),a.addClass("btn-success"),$(".ctrlPowerOff").css("display","block"),event.preventDefault(),event.stopPropagation()};$("#"+a).on("click",o)}("ctrlDrawMarker",google.maps.drawing.OverlayType.MARKER),$("#ctrlDrawOFF").click(function(){e.emergencyDrawingManager.setMap(null),e.otherDrawingManager.setMap(null);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-success"),a.addClass("btn-primary"),$(".ctrlPowerOff").css("display","none")}),google.maps.event.addListener(this.emergencyDrawingManager,"overlaycomplete",function(a){if(a.type==google.maps.drawing.OverlayType.MARKER){e.emergencyMarker&&(e.map.data.remove(e.emergencyMarker),e.emergencyRadius&&e.map.data.remove(e.emergencyRadius));var t=a.overlay;t.setMap(null),microtime=e.microtime();var o=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(t.getPosition()),properties:{type:"LUGAR_EMERGENCIA",icon:baseUrl+"assets/img/emergencia.png",infoWindow:"Lugar de la emergencia",midas:!0,microtime:microtime,nombre:"Lugar de la Emergencia"}});e.map.data.add(o),e.emergencyMarker=o,e.map.setCenter(e.emergencyMarker.getGeometry().get()),$("#mRadioEmergencia").modal("show"),$("#iRadioEmergencia").closest("div").removeClass("has-error")}$("#ctrlDrawOFF").click()}),$("#btnGuardarRadioEmergencia").click(l.bind(this)),$("#mRadioEmergencia").on("shown.bs.modal",function(e){$("#iRadioEmergencia").focus(),$("#iRadioEmergencia").select()}),$("#frmRadioEmergencia").submit(function(){return $("#btnGuardarRadioEmergencia").click(),!1})},this.makeOthersManager=function(){var e=this;this.otherDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON]},clickable:!1,editable:!0,zIndex:1}),this.otherDrawingManager.setMap(null);for(var a=[{id:"ctrlOtherDrawLine",overlay:google.maps.drawing.OverlayType.POLYLINE},{id:"ctrlOtherDrawPolygon",overlay:google.maps.drawing.OverlayType.POLYGON},{id:"ctrlOtherDrawCircle",overlay:google.maps.drawing.OverlayType.CIRCLE},{id:"ctrlOtherDrawRectangle",overlay:google.maps.drawing.OverlayType.RECTANGLE},{id:"ctrlOtherDrawMarker",overlay:google.maps.drawing.OverlayType.MARKER}],t=0;t<a.length;t++)!function(e,a){var t=function(){$("#mOtrosEmergencias").modal("show"),e.otherControlSelected=a};$("#"+a.id).on("click",t)}(this,a[t]);google.maps.event.addListener(this.otherDrawingManager,"overlaycomplete",function(a){var t=a.overlay;t.setMap(null);var o,r,n,i,s=e.microtime();switch(a.type){case google.maps.drawing.OverlayType.POLYLINE:for(o=[],r=0;r<t.getPath().getLength();r++)i=t.getPath().getAt(r),o.push(i);n=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(o),properties:{strokeColor:e.otherControlColor,type:"POLYLINE",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.POLYGON:for(o=[[]],r=0;r<t.getPath().getLength();r++)i=t.getPath().getAt(r),o[0].push(i);n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:e.otherControlColor,type:"POLYGON",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.CIRCLE:o=p(t),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:e.otherControlColor,type:"CIRCLE",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.RECTANGLE:o=[[]];var l=t.getBounds();o[0].push(l.getNorthEast()),o[0].push({lat:l.getSouthWest().lat(),lng:l.getNorthEast().lng()}),o[0].push(l.getSouthWest()),o[0].push({lat:l.getNorthEast().lat(),lng:l.getSouthWest().lng()}),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:e.otherControlColor,type:"RECTANGLE",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.MARKER:var c=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(t.getPosition()),properties:{type:"PUNTO",icon:baseUrl+"assets/img/spotlight-poi-"+e.otherControlDataColor+".png",infoWindow:e.otherControlSelected.title,nombre:e.otherControlSelected.title,microtime:s,midas:!0}});e.map.data.add(c)}$("#ctrlDrawOFF").click()}),$("#btnGuardarOtrosEmergencia").click(c.bind(this)),$("#botoneraColorControl a").click(function(){$("#botoneraColorControl a i").removeClass("fa fa-check-circle-o"),$(this).find("i").addClass("fa fa-check-circle-o"),$(this).addClass("selected"),e.otherControlColor=Utils.rgb2hex($(this).css("background-color")),e.otherControlDataColor=$(this).attr("data-color")})},this.loadKML=function(e){var a=this,t=new google.maps.KmlLayer({url:e,map:this.map,suppressInfoWindows:!0,preserveViewport:!0});t.addListener("click",function(e){var t=new google.maps.InfoWindow({content:e.featureData.infoWindowHtml});t.setPosition(e.latLng),t.open(a.map)})},this.detectHeight=function(){$(this.canvas).css("height",$("html").height()-$("div.header").height()+"px")},this.makeSearchBox=function(){var e=$("#input-buscador-mapa").get(0),a=new google.maps.places.SearchBox(e),t=this,o=[];this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),this.map.addListener("bounds_changed",function(){a.setBounds(t.map.getBounds())}),a.addListener("places_changed",function(){console.log(a.getPlaces());var e=a.getPlaces();if(0!==e.length){o.forEach(function(e){e.setMap(null)}),o=[];var r=new google.maps.LatLngBounds;e.forEach(function(e){var a={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};o.push(new google.maps.Marker({map:t.map,icon:a,title:e.name,position:e.geometry.location})),e.geometry.viewport?r.union(e.geometry.viewport):r.extend(e.geometry.location)}),t.map.fitBounds(r)}})};var l=function(){var e=$("#iRadioEmergencia").val();if(""===e.trim())return $("#iRadioEmergencia").closest("div").addClass("has-error"),!1;if($("#iRadioEmergencia").val("0"),$("#mRadioEmergencia").modal("hide"),0===e)return!0;var a=new google.maps.Circle({map:null,radius:parseInt(e),fillColor:"#FF0000",center:this.emergencyMarker.getGeometry().get()}),o=p(a),r=t.microtime(),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:"#FF0000",type:"RADIO_EMERGENCIA",infoWindow:"Radio de la emergencia",midas:!0,microtime:r,nombre:"Lugar de la Emergencia"}});this.map.data.add(n),this.emergencyRadius=n,this.map.data.remove(this.referenciaMarker)},c=function(){if(!$("#botoneraColorControl a.selected").length)return $("#botoneraColorControl").closest("div").addClass("has-error"),!1;if(!$("#iTituloComponente").val())return $("#iTituloComponente").closest("div").addClass("has-error"),!1;$("#ctrlDraw").addClass("btn-success").removeClass("btn-primary"),this.otherDrawingManager.setDrawingMode(this.otherControlSelected.overlay),this.otherDrawingManager.setMap(this.map),this.otherControlSelected.title=$("#iTituloComponente").val();for(var e=["polygonOptions","circleOptions","rectangleOptions"],a=0;a<e.length;a++)this.otherDrawingManager.set(e[a],{fillColor:this.otherControlColor});this.otherDrawingManager.set("polylineOptions",{strokeColor:this.otherControlColor}),$("#mOtrosEmergencias").modal("hide")},g=360,p=function(e){for(var a=[[]],t=360/g,o=null,r=0;g>r;r++)o=google.maps.geometry.spherical.computeOffset(e.getCenter(),e.getRadius(),t*r),a[0].push(o);return a}}).apply(VisorMapa);