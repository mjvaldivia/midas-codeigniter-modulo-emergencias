var VisorMapa={map:null,canvas:null,emergencyDrawingManager:null,emergencyMarker:null,emergencyRadius:null,otherDrawingManager:null,otherControlColor:null,otherControlSelected:null,otherFeatures:{circles:[],rectangles:[],polylines:[],polygons:[],markers:[]},otherInfoListener:null,iteracionTemporal:1};(function(){this.init=function(e){this.canvas=$("#mapa").get(0),$(window).resize(this.detectHeight.bind(this));var a={center:new google.maps.LatLng(-33.07,-71.6),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:12},r=$.extend(a,e);this.detectHeight.call(this),this.map=new google.maps.Map(this.canvas,r),this.makeSearchBox.call(this),this.makeEmergencyDrawManager.call(this),this.makeOthersManager.call(this),this.constructControlIns.call(this),this.constructControlLayer.call(this),this.constructControlInfo.call(this)},this.constructControlInfo=function(){var e=this;$("#ctrlInfo").click(function(){var a=this;if(!$(this).hasClass("btn-success")){$(this).removeClass("btn-primary").addClass("btn-success");for(var r=0;r<e.otherFeatures.polygons.length;r++){var n=e.otherFeatures.polygons[r];!function(e,a,r){var n=function(){$("#mInfo").modal("show"),google.maps.event.removeListener(e.otherInfoListener),$(a).removeClass("btn-success").addClass("btn-primary")},o=r.addListener("click",n);e.otherInfoListener=o}(e,a,n)}}})},this.constructControlLayer=function(){{var e=this;$("#tblCtrlCapas").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},columns:[{mRender:function(e){return'<input id="iCtrlLayers'+e+'" name="iCtrlLayers[]" type="checkbox"/>'},sWidth:"30px"},{sType:"string"}],pagingType:"simple",order:[[1,"asc"]]})}$("#ctrlLayers").click(function(){$("#mCapas").modal("show")}),$("#btnCargarCapas").click(function(){1==e.iteracionTemporal?(e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=bodegas_quimico"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=quimicas")):2==e.iteracionTemporal&&(e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=hospitales"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=atencion_primaria"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=centros_salud"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=servicentros"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=jardines"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=instalaciones_quimicas"),e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=liceos_colegios")),e.iteracionTemporal++,$("#mCapas").modal("hide")})},this.constructControlIns=function(){{var e=this;$("#tblTiposIns").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},ajax:{url:siteUrl+"instalacion/obtenerJsonTipos",type:"GET",async:!0},columns:[{mRender:function(e,a,r){return'<input id="iTipIns'+r.aux_ia_id+'" name="iTipIns[]" type="checkbox"/>'}},{data:"amb_c_nombre"},{data:"aux_c_nombre"}],pagingType:"simple"})}$("#ctrlIns").click(function(){$("#mMaestroInstalaciones").modal("show")}),$("#btnCargarIns").click(function(){e.loadKML("http://ssrv.cl/emergencias_test/kml.php?name=eleam"),$("#mMaestroInstalaciones").modal("hide")})},this.makeEmergencyDrawManager=function(){var a=this;this.emergencyDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER]},clickable:!1,editable:!0,zIndex:1}),this.emergencyDrawingManager.setMap(null),function(e,r){var n=function(){a.emergencyDrawingManager.setDrawingMode(r),a.emergencyDrawingManager.setMap(a.map);var e=$(this).parents("div").first().find("a.btn");e.removeClass("btn-primary"),e.addClass("btn-success"),$(".ctrlPowerOff").css("display","block"),event.preventDefault(),event.stopPropagation()};$("#"+e).on("click",n)}("ctrlDrawMarker",google.maps.drawing.OverlayType.MARKER),$("#ctrlDrawOFF").click(function(){a.emergencyDrawingManager.setMap(null),a.otherDrawingManager.setMap(null);var e=$(this).parents("div").first().find("a.btn");e.removeClass("btn-success"),e.addClass("btn-primary"),$(".ctrlPowerOff").css("display","none")}),google.maps.event.addListener(this.emergencyDrawingManager,"overlaycomplete",function(e){a.emergencyMarker&&(a.emergencyMarker.setMap(null),a.emergencyRadius&&a.emergencyRadius.setMap(null));var r=new google.maps.InfoWindow({content:"Lugar de la emergencia"});if(e.type==google.maps.drawing.OverlayType.MARKER){var n=e.overlay;a.emergencyMarker=n,a.emergencyMarker.addListener("click",function(){r.open(a.map,a.emergencyMarker)}),$("#mRadioEmergencia").modal("show"),$("#iRadioEmergencia").closest("div").removeClass("has-error")}$("#ctrlDrawOFF").click()}),$("#btnGuardarRadioEmergencia").click(e.bind(this)),$("#mRadioEmergencia").on("shown.bs.modal",function(){$("#iRadioEmergencia").focus(),$("#iRadioEmergencia").select()}),$("#frmRadioEmergencia").submit(function(){return $("#btnGuardarRadioEmergencia").click(),!1})},this.makeOthersManager=function(){var e=this;this.otherDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON]},clickable:!1,editable:!0,zIndex:1}),this.otherDrawingManager.setMap(null);for(var r=[{id:"ctrlOtherDrawLine",overlay:google.maps.drawing.OverlayType.POLYLINE},{id:"ctrlOtherDrawPolygon",overlay:google.maps.drawing.OverlayType.POLYGON},{id:"ctrlOtherDrawCircle",overlay:google.maps.drawing.OverlayType.CIRCLE},{id:"ctrlOtherDrawRectangle",overlay:google.maps.drawing.OverlayType.RECTANGLE},{id:"ctrlOtherDrawMarker",overlay:google.maps.drawing.OverlayType.MARKER}],n=0;n<r.length;n++)!function(e,a){var r=function(){$("#mOtrosEmergencias").modal("show"),e.otherControlSelected=a};$("#"+a.id).on("click",r)}(this,r[n]);google.maps.event.addListener(this.otherDrawingManager,"overlaycomplete",function(a){var r=a.overlay,n=new google.maps.InfoWindow({content:e.otherControlSelected.title}),o=[google.maps.drawing.OverlayType.POLYGON,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE];switch(-1!=o.indexOf(a.type)&&r.addListener("click",function(a){n.setPosition(a.latLng),n.open(e.map)}),a.type){case google.maps.drawing.OverlayType.POLYGON:e.otherFeatures.polygons.push(r);break;case google.maps.drawing.OverlayType.CIRCLE:e.otherFeatures.circles.push(r);break;case google.maps.drawing.OverlayType.POLYLINE:e.otherFeatures.polylines.push(r);break;case google.maps.drawing.OverlayType.RECTANGLE:e.otherFeatures.rectangles.push(r);break;case google.maps.drawing.OverlayType.MARKER:e.otherFeatures.markers.push(r)}$("#ctrlDrawOFF").click()}),$("#btnGuardarOtrosEmergencia").click(a.bind(this)),$("#botoneraColorControl a").click(function(){$("#botoneraColorControl a i").removeClass("fa fa-check-circle-o"),$(this).find("i").addClass("fa fa-check-circle-o"),$(this).addClass("selected"),e.otherControlColor=Utils.rgb2hex($(this).css("background-color"))})},this.loadKML=function(e){var a=this,r=new google.maps.KmlLayer({url:e,map:this.map,suppressInfoWindows:!0,preserveViewport:!0});r.addListener("click",function(e){var r=new google.maps.InfoWindow({content:e.featureData.infoWindowHtml});console.log(e),r.setPosition(e.latLng),r.open(a.map)})},this.detectHeight=function(){$(this.canvas).css("height",$("html").height()-$("div.header").height()+"px")},this.makeSearchBox=function(){var e=$("#input-buscador-mapa").get(0),a=new google.maps.places.SearchBox(e),r=this,n=[];this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),this.map.addListener("bounds_changed",function(){a.setBounds(r.map.getBounds())}),a.addListener("places_changed",function(){var e=a.getPlaces();if(0!==e.length){n.forEach(function(e){e.setMap(null)}),n=[];var o=new google.maps.LatLngBounds;e.forEach(function(e){var a={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};n.push(new google.maps.Marker({map:r.map,icon:a,title:e.name,position:e.geometry.location})),e.geometry.viewport?o.union(e.geometry.viewport):o.extend(e.geometry.location)}),r.map.fitBounds(o)}})};var e=function(){var e=$("#iRadioEmergencia").val();if(""===e.trim())return $("#iRadioEmergencia").closest("div").addClass("has-error"),!1;if($("#iRadioEmergencia").val("0"),$("#mRadioEmergencia").modal("hide"),0===e)return!0;this.emergencyRadius=new google.maps.Circle({map:this.map,radius:parseInt(e),fillColor:"#FF0000",center:{lat:this.emergencyMarker.position.G,lng:this.emergencyMarker.position.K}});var a=new google.maps.InfoWindow({content:"Radio de la emergencia"});this.emergencyRadius.addListener("click",function(e){a.setPosition(e.latLng),a.open(this.map)})},a=function(){if(!$("#botoneraColorControl a.selected").length)return $("#botoneraColorControl").closest("div").addClass("has-error"),!1;if(!$("#iTituloComponente").val())return $("#iTituloComponente").closest("div").addClass("has-error"),!1;$("#ctrlDraw").addClass("btn-success").removeClass("btn-primary"),this.otherDrawingManager.setDrawingMode(this.otherControlSelected.overlay),this.otherDrawingManager.setMap(this.map),this.otherControlSelected.title=$("#iTituloComponente").val();for(var e=["polygonOptions","circleOptions","rectangleOptions"],a=0;a<e.length;a++)this.otherDrawingManager.set(e[a],{fillColor:this.otherControlColor});this.otherDrawingManager.set("polylineOptions",{strokeColor:this.otherControlColor}),$("#mOtrosEmergencias").modal("hide")}}).apply(VisorMapa);