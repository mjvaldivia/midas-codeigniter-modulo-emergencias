var VisorMapa={map:null,canvas:null,emergencyDrawingManager:null,emergencyMarker:null,emergencyRadius:null,otherDrawingManager:null,otherControlColor:null,otherControlSelected:null};(function(){var e=function(){var e=$("#iRadioEmergencia").val();if(""==e.trim())return $("#iRadioEmergencia").closest("div").addClass("has-error"),!1;if($("#iRadioEmergencia").val("0"),$("#mRadioEmergencia").modal("hide"),0==e)return!0;this.emergencyRadius=new google.maps.Circle({map:this.map,radius:parseInt(e),fillColor:"#FF0000",center:{lat:this.emergencyMarker.position.G,lng:this.emergencyMarker.position.K}});var a=new google.maps.InfoWindow({content:"Radio de la emergencia"});this.emergencyRadius.addListener("click",function(e){a.setPosition(e.latLng),a.open(this.map)})},a=function(){if(!$("#botoneraColorControl a.selected").length)return $("#botoneraColorControl").closest("div").addClass("has-error"),!1;if(!$("#iTituloComponente").val())return $("#iTituloComponente").closest("div").addClass("has-error"),!1;$("#ctrlDraw").addClass("btn-success").removeClass("btn-primary"),this.otherDrawingManager.setDrawingMode(this.otherControlSelected.overlay),this.otherDrawingManager.setMap(this.map),this.otherControlSelected.title=$("#iTituloComponente").val();for(var e=["polygonOptions","circleOptions","rectangleOptions"],a=0;a<e.length;a++)this.otherDrawingManager.set(e[a],{fillColor:this.otherControlColor});this.otherDrawingManager.set("polylineOptions",{strokeColor:this.otherControlColor}),$("#mOtrosEmergencias").modal("hide")};this.init=function(r){var o=this;this.canvas=$("#mapa").get(0),$(window).resize(this.detectHeight.bind(this));var n={center:new google.maps.LatLng(-33.0507081,-71.6110485),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:8},i=$.extend(n,r);this.detectHeight.call(this),this.map=new google.maps.Map(this.canvas,i),this.makeSearchBox.call(this),this.makeEmergencyDrawManager.call(this),this.makeOthersManager.call(this),$("#btnGuardarRadioEmergencia").click(e.bind(this)),$("#btnGuardarOtrosEmergencia").click(a.bind(this)),$("#mRadioEmergencia").on("shown.bs.modal",function(){$("#iRadioEmergencia").focus(),$("#iRadioEmergencia").select()}),$("#frmRadioEmergencia").submit(function(){return $("#btnGuardarRadioEmergencia").click(),!1}),$("#botoneraColorControl a").click(function(){$("#botoneraColorControl a i").removeClass("fa fa-check-circle-o"),$(this).find("i").addClass("fa fa-check-circle-o"),$(this).addClass("selected"),o.otherControlColor=Utils.rgb2hex($(this).css("background-color"))})},this.makeEmergencyDrawManager=function(){var e=this;this.emergencyDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER]},clickable:!1,editable:!0,zIndex:1}),this.emergencyDrawingManager.setMap(null),function(a,r){var o=function(){e.emergencyDrawingManager.setDrawingMode(r),e.emergencyDrawingManager.setMap(e.map);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-primary"),a.addClass("btn-success"),$(".ctrlPowerOff").css("display","block"),event.preventDefault(),event.stopPropagation()};$("#"+a).on("click",o)}("ctrlDrawMarker",google.maps.drawing.OverlayType.MARKER),$("#ctrlDrawOFF").click(function(){e.emergencyDrawingManager.setMap(null),e.otherDrawingManager.setMap(null);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-success"),a.addClass("btn-primary"),$(".ctrlPowerOff").css("display","none")}),google.maps.event.addListener(this.emergencyDrawingManager,"overlaycomplete",function(a){e.emergencyMarker&&(e.emergencyMarker.setMap(null),e.emergencyRadius&&e.emergencyRadius.setMap(null));var r=new google.maps.InfoWindow({content:"Lugar de la emergencia"});if(a.type==google.maps.drawing.OverlayType.MARKER){var o=a.overlay;e.emergencyMarker=o,e.emergencyMarker.addListener("click",function(){r.open(e.map,e.emergencyMarker)}),$("#mRadioEmergencia").modal("show"),$("#iRadioEmergencia").closest("div").removeClass("has-error")}$("#ctrlDrawOFF").click()})},this.makeOthersManager=function(){var e=this;this.otherDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON]},clickable:!1,editable:!0,zIndex:1}),this.otherDrawingManager.setMap(null);for(var a=[{id:"ctrlOtherDrawLine",overlay:google.maps.drawing.OverlayType.POLYLINE},{id:"ctrlOtherDrawPolygon",overlay:google.maps.drawing.OverlayType.POLYGON},{id:"ctrlOtherDrawCircle",overlay:google.maps.drawing.OverlayType.CIRCLE},{id:"ctrlOtherDrawRectangle",overlay:google.maps.drawing.OverlayType.RECTANGLE},{id:"ctrlOtherDrawMarker",overlay:google.maps.drawing.OverlayType.MARKER}],r=0;r<a.length;r++)!function(e,a){var r=function(){$("#mOtrosEmergencias").modal("show"),e.otherControlSelected=a};$("#"+a.id).on("click",r)}(this,a[r]);google.maps.event.addListener(this.otherDrawingManager,"overlaycomplete",function(a){var r=a.overlay,o=new google.maps.InfoWindow({content:e.otherControlSelected.title}),n=[google.maps.drawing.OverlayType.POLYGON,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE];console.log(a.type,n),-1!=n.indexOf(a.type)&&r.addListener("click",function(a){o.setPosition(a.latLng),o.open(e.map)}),$("#ctrlDrawOFF").click()})},this.loadKML=function(){var e=new google.maps.KmlLayer({url:"http://ssrv.cl/sipresa_test/kml.php",map:this.map,suppressInfoWindows:!0,preserveViewport:!1});e.addListener("click",function(e){var a=e.featureData.infoWindowHtml,r=document.getElementById("capture");r.innerHTML=a})},this.detectHeight=function(){$(this.canvas).css("height",$("html").height()-$("div.header").height()+"px")},this.makeSearchBox=function(){var e=$("#input-buscador-mapa").get(0),a=new google.maps.places.SearchBox(e),r=this,o=[];this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),this.map.addListener("bounds_changed",function(){a.setBounds(r.map.getBounds())}),a.addListener("places_changed",function(){var e=a.getPlaces();if(0!=e.length){o.forEach(function(e){e.setMap(null)}),o=[];var n=new google.maps.LatLngBounds;e.forEach(function(e){var a={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};o.push(new google.maps.Marker({map:r.map,icon:a,title:e.name,position:e.geometry.location})),e.geometry.viewport?n.union(e.geometry.viewport):n.extend(e.geometry.location)}),r.map.fitBounds(n)}})}}).apply(VisorMapa);