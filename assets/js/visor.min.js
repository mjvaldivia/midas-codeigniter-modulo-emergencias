var VisorMapa={map:null,canvas:null,emergencyMarker:null,emergencyRadius:null,emergencyDrawingManager:null,otherDrawingManager:null,otherControlColor:null,otherControlDataColor:null,otherControlSelected:null,otherStatusInfoControl:"off"};(function(){var e=null;this.init=function(e){this.opciones=e,$.get(siteUrl+"emergencia/obtenerJsonEmergenciaVisor/id/"+$("#hIdEmergencia").val()).done(this.makeMap.bind(this))},this.makeMap=function(o){for(var t=this,r=JSON.parse(o),n=new google.maps.LatLngBounds,i=0;i<r.coordinates.length;i++){var s=r.coordinates[i];if(s.com_c_xmin&&s.com_c_ymin&&s.com_c_xmax&&s.com_c_ymax){var l=GeoEncoder.utmToDecimalDegree(parseFloat(s.com_c_xmin),parseFloat(s.com_c_ymin),s.com_c_geozone);n.extend(new google.maps.LatLng(l[0],l[1])),l=GeoEncoder.utmToDecimalDegree(parseFloat(s.com_c_xmax),parseFloat(s.com_c_ymax),s.com_c_geozone),n.extend(new google.maps.LatLng(l[0],l[1]))}}this.canvas=$("#mapa").get(0),$(window).resize(this.detectHeight.bind(this));var c={center:new google.maps.LatLng(-33.07,-71.6),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:12},g=$.extend(c,e);this.detectHeight.call(this),this.map=new google.maps.Map(this.canvas,g),this.map.fitBounds(n),this.makeSearchBox.call(this),this.makeEmergencyDrawManager.call(this),this.makeOthersManager.call(this),this.constructControlIns.call(this),this.constructControlLayer.call(this),this.constructControlInfo.call(this),this.constructControlSave.call(this),this.map.data.setStyle(function(e){var a=null,o={};return e.getProperty("fillColor")&&(a=e.getProperty("color"),o.fillOpacity=.3,o.fillColor=e.getProperty("fillColor")),e.getProperty("strokeColor")&&(o.strokeColor=e.getProperty("strokeColor")),e.getProperty("icon")&&(o.icon=e.getProperty("icon")),o}),this.map.data.addListener("click",function(e){if("on"==t.otherStatusInfoControl)return a.call(t,e);if(e.feature.getProperty("infoWindow")){var o=new google.maps.InfoWindow({content:e.feature.getProperty("infoWindow"),position:e.latLng});o.open(t.map)}}),r.geojson&&this.map.data.loadGeoJson(r.geojson,null,function(e){for(var a=0;a<e.length;a++){var o=e[a];"LUGAR_EMERGENCIA"==o.getProperty("type")?t.emergencyMarker=o:"RADIO_EMERGENCIA"==o.getProperty("type")&&(t.emergencyRadius=o)}})};var a=function(e){if("Polygon"!=e.feature.getGeometry().getType())return null;var a,n,i=o.call(this),s=[],l=new google.maps.Polygon({map:null});for(l.setPaths(e.feature.getGeometry().getAt(0).getArray()),n=0;n<i.length;n++)a=i[n],"Point"==a.getGeometry().getType()&&"LUGAR_EMERGENCIA"!=a.getProperty("type")&&google.maps.geometry.poly.containsLocation(a.getGeometry().get(),l)&&s.push(a);var c,g,p,m,d=null,h=[];for(n=0,m=1;n<s.length;n++)if(-1==h.indexOf(d)){c={},c.data=[],d=s[n].getProperty("type");for(var u=n;u<s.length;u++)a=s[u],d==a.getProperty("type")&&(c.data.push(t(a)),c.columns=r(d,t(a)));h.push(d),p="Capa "+d,g="crossingDT_"+m++;var f=$("#moldeCruce").html();f=f.replace(/__titulo__/g,p),f=f.replace(/__id_tabla__/g,g),$("#mInfoContent").html(""),$("#mInfoContent").prepend(f),$("#"+g).DataTable({columns:c.columns,data:c.data,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"}}),$("#mInfo").modal("show"),$("#ctrlInfo").click()}return null},o=function(){var e=[];return this.map.data.forEach(function(a){e.push(a)}),e},t=function(e){var a={};return e.forEachProperty(function(e,o){a[o]=e}),a},r=function(e,a){var o,t=["midas","icon","infoWindow","type"],r=[];switch(e){case"INSTALACION":o={mData:"id_maestro",sTitle:"ID"},r.push(o),o={mData:"razon_social",sTitle:"Razón Social"},r.push(o),o={mData:"nombre_fantasia",sTitle:"Nombre Fantasía"},r.push(o),o={mData:"direccion",sTitle:"Dirección"},r.push(o);break;default:for(var n in a)a.hasOwnProperty(n)&&(o={},o.mData=n,o.sTitle=n,-1!=t.indexOf(n)&&(o.bVisible=!1),r.push(o))}return r};this.constructControlInfo=function(){var e=this;$("#ctrlInfo").click(function(){return $(this).hasClass("btn-success")?($(this).removeClass("btn-success").addClass("btn-primary"),void(e.otherStatusInfoControl="off")):($(this).removeClass("btn-primary").addClass("btn-success"),void(e.otherStatusInfoControl="on"))})},this.constructControlSave=function(){var e=this;$("#ctrlSave").click(function(){var a={type:"FeatureCollection",features:[]};e.map.data.toGeoJson(function(e){for(var o=0;o<e.features.length;o++){var t=e.features[o];t.properties.midas&&a.features.push(t)}var r=JSON.stringify(a),n="id="+$("#hIdEmergencia").val()+"&geoJson="+r;$.post(siteUrl+"visor/saveGeoJson",n).done()})})},this.constructControlLayer=function(){var e=this;$("#tblCtrlCapas tfoot th").each(function(){var e=$("#tblCtrlCapas thead th").eq($(this).index()).text();$(this).html('<input type="text" class="form-control" placeholder="'+e+'" />')});var a=$("#tblCtrlCapas").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},columns:[{mRender:function(e,a,o){return'<input id="iCtrlLayers'+e+'" name="iCtrlLayers[]" type="checkbox"/>'},sWidth:"30px"},{sType:"string"}],pagingType:"simple",order:[[1,"asc"]]});$("#tblCtrlCapas").on("init.dt",function(e,o,t){a.columns().every(function(){var e=this;$("input",this.footer()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})})}),$("#ctrlLayers").click(function(){$("#mCapas").modal("show")}),e.iteracionTemporal=1,$("#btnCargarCapas").click(function(){1==e.iteracionTemporal++&&e.map.data.loadGeoJson(baseUrl+"kml/manzanas.json"),$("#mCapas").modal("hide")})};var n=function(){var e=this;this.map.data.forEach(function(a){"INSTALACION"==a.getProperty("type")&&e.map.data.remove(a)})},i=function(e){var a=JSON.parse(e);n.call(this);for(var o=0;o<a.length;o++){var t=a[o];if(t.ins_c_latitud&&t.ins_c_longitud){var r=$("#moldeIns").html();r=r.replace(/__razon_social__/g,t.ins_c_razon_social),r=r.replace(/__nombre_fantasia__/g,t.ins_c_nombre_fantasia),r=r.replace(/__comuna__/g,t.com_c_nombre),r=r.replace(/__region__/g,t.reg_c_nombre),r=r.replace(/__direccion__/g,t.ins_c_nombre_direccion+", "+t.ins_c_numero_direccion+" "+t.ins_c_resto_direccion+" ");var i=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(t.ins_c_latitud),lng:parseFloat(t.ins_c_longitud)}),properties:{type:"INSTALACION",icon:baseUrl+"assets/img/spotlight-poi.png",infoWindow:r,id_maestro:t.ins_ia_id,razon_social:t.ins_c_razon_social,nombre_fantasia:t.ins_c_nombre_fantasia,direccion:t.ins_c_nombre_direccion+", "+t.ins_c_numero_direccion+" "+t.ins_c_resto_direccion,midas:!0}});this.map.data.add(i)}}};this.constructControlIns=function(){var e=this;$("#tblTiposIns tfoot th").each(function(){var e=$("#tblTiposIns thead th").eq($(this).index()).text();$(this).html('<input type="text" class="form-control" placeholder="'+e+'" />')});var a=$("#tblTiposIns").DataTable({language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},ajax:{url:siteUrl+"instalacion/obtenerJsonDtTipos",type:"GET",async:!0},columns:[{mRender:function(e,a,o){return'<input id="iTipIns'+o.aux_ia_id+'" name="iTipIns[]" value="'+o.aux_ia_id+'" type="checkbox"/>'}},{data:"amb_c_nombre"},{data:"aux_c_nombre"}],pagingType:"simple"});$("#tblTiposIns").on("init.dt",function(e,o,t){a.columns().every(function(){var e=this;$("input",this.footer()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})})}),$("#ctrlIns").click(function(){$("#mMaestroInstalaciones").modal("show")}),$("#btnCargarIns").click(function(){var a={};a.idEmergencia=$("#hIdEmergencia").val(),a.tiposIns=[];for(var o=$("input[type='checkbox'][name='iTipIns[]']:checked"),t=0;t<o.length;t++)a.tiposIns.push(o[t].value);$.post(siteUrl+"instalacion/obtenerJsonInsSegunTipIns",a).done(i.bind(e)),$("#mMaestroInstalaciones").modal("hide")})},this.makeEmergencyDrawManager=function(){var e=this;this.emergencyDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER]},clickable:!1,editable:!0,zIndex:1}),this.emergencyDrawingManager.setMap(null),function(a,o){var t=function(){e.emergencyDrawingManager.setDrawingMode(o),e.emergencyDrawingManager.setMap(e.map);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-primary"),a.addClass("btn-success"),$(".ctrlPowerOff").css("display","block"),event.preventDefault(),event.stopPropagation()};$("#"+a).on("click",t)}("ctrlDrawMarker",google.maps.drawing.OverlayType.MARKER),$("#ctrlDrawOFF").click(function(){e.emergencyDrawingManager.setMap(null),e.otherDrawingManager.setMap(null);var a=$(this).parents("div").first().find("a.btn");a.removeClass("btn-success"),a.addClass("btn-primary"),$(".ctrlPowerOff").css("display","none")}),google.maps.event.addListener(this.emergencyDrawingManager,"overlaycomplete",function(a){if(a.type==google.maps.drawing.OverlayType.MARKER){e.emergencyMarker&&(e.map.data.remove(e.emergencyMarker),e.emergencyRadius&&e.map.data.remove(e.emergencyRadius));var o=a.overlay;o.setMap(null);var t=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(o.getPosition()),properties:{type:"LUGAR_EMERGENCIA",icon:baseUrl+"assets/img/spotlight-poi.png",infoWindow:"Lugar de la emergencia",midas:!0}});e.map.data.add(t),e.emergencyMarker=t,$("#mRadioEmergencia").modal("show"),$("#iRadioEmergencia").closest("div").removeClass("has-error")}$("#ctrlDrawOFF").click()}),$("#btnGuardarRadioEmergencia").click(s.bind(this)),$("#mRadioEmergencia").on("shown.bs.modal",function(e){$("#iRadioEmergencia").focus(),$("#iRadioEmergencia").select()}),$("#frmRadioEmergencia").submit(function(){return $("#btnGuardarRadioEmergencia").click(),!1})},this.makeOthersManager=function(){var e=this;this.otherDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON]},clickable:!1,editable:!0,zIndex:1}),this.otherDrawingManager.setMap(null);for(var a=[{id:"ctrlOtherDrawLine",overlay:google.maps.drawing.OverlayType.POLYLINE},{id:"ctrlOtherDrawPolygon",overlay:google.maps.drawing.OverlayType.POLYGON},{id:"ctrlOtherDrawCircle",overlay:google.maps.drawing.OverlayType.CIRCLE},{id:"ctrlOtherDrawRectangle",overlay:google.maps.drawing.OverlayType.RECTANGLE},{id:"ctrlOtherDrawMarker",overlay:google.maps.drawing.OverlayType.MARKER}],o=0;o<a.length;o++)!function(e,a){var o=function(){$("#mOtrosEmergencias").modal("show"),e.otherControlSelected=a};$("#"+a.id).on("click",o)}(this,a[o]);google.maps.event.addListener(this.otherDrawingManager,"overlaycomplete",function(a){var o=a.overlay;o.setMap(null);var t,r,n,i;switch(a.type){case google.maps.drawing.OverlayType.POLYLINE:for(t=[],r=0;r<o.getPath().getLength();r++)i=o.getPath().getAt(r),t.push(i);n=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(t),properties:{strokeColor:e.otherControlColor,type:"POLYLINE",infoWindow:e.otherControlSelected.title,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.POLYGON:for(t=[[]],r=0;r<o.getPath().getLength();r++)i=o.getPath().getAt(r),t[0].push(i);n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(t),properties:{fillColor:e.otherControlColor,type:"POLYGON",infoWindow:e.otherControlSelected.title,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.CIRCLE:t=g(o),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(t),properties:{fillColor:e.otherControlColor,type:"CIRCLE",infoWindow:e.otherControlSelected.title,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.RECTANGLE:t=[[]];var s=o.getBounds();t[0].push(s.getNorthEast()),t[0].push({lat:s.getSouthWest().lat(),lng:s.getNorthEast().lng()}),t[0].push(s.getSouthWest()),t[0].push({lat:s.getNorthEast().lat(),lng:s.getSouthWest().lng()}),n=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(t),properties:{fillColor:e.otherControlColor,type:"RECTANGLE",infoWindow:e.otherControlSelected.title,midas:!0}}),e.map.data.add(n);break;case google.maps.drawing.OverlayType.MARKER:var l=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(o.getPosition()),properties:{type:"PUNTO",icon:baseUrl+"assets/img/spotlight-poi-"+e.otherControlDataColor+".png",infoWindow:e.otherControlSelected.title,midas:!0}});e.map.data.add(l)}$("#ctrlDrawOFF").click()}),$("#btnGuardarOtrosEmergencia").click(l.bind(this)),$("#botoneraColorControl a").click(function(){$("#botoneraColorControl a i").removeClass("fa fa-check-circle-o"),$(this).find("i").addClass("fa fa-check-circle-o"),$(this).addClass("selected"),e.otherControlColor=Utils.rgb2hex($(this).css("background-color")),e.otherControlDataColor=$(this).attr("data-color")})},this.loadKML=function(e){var a=this,o=new google.maps.KmlLayer({url:e,map:this.map,suppressInfoWindows:!0,preserveViewport:!0});o.addListener("click",function(e){var o=new google.maps.InfoWindow({content:e.featureData.infoWindowHtml});o.setPosition(e.latLng),o.open(a.map)})},this.detectHeight=function(){$(this.canvas).css("height",$("html").height()-$("div.header").height()+"px")},this.makeSearchBox=function(){var e=$("#input-buscador-mapa").get(0),a=new google.maps.places.SearchBox(e),o=this,t=[];this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),this.map.addListener("bounds_changed",function(){a.setBounds(o.map.getBounds())}),a.addListener("places_changed",function(){var e=a.getPlaces();if(0!==e.length){t.forEach(function(e){e.setMap(null)}),t=[];var r=new google.maps.LatLngBounds;e.forEach(function(e){var a={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};t.push(new google.maps.Marker({map:o.map,icon:a,title:e.name,position:e.geometry.location})),e.geometry.viewport?r.union(e.geometry.viewport):r.extend(e.geometry.location)}),o.map.fitBounds(r)}})};var s=function(){var e=$("#iRadioEmergencia").val();if(""===e.trim())return $("#iRadioEmergencia").closest("div").addClass("has-error"),!1;if($("#iRadioEmergencia").val("0"),$("#mRadioEmergencia").modal("hide"),0===e)return!0;var a=new google.maps.Circle({map:null,radius:parseInt(e),fillColor:"#FF0000",center:this.emergencyMarker.getGeometry().get()}),o=g(a),t=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(o),properties:{fillColor:"#FF0000",type:"RADIO_EMERGENCIA",infoWindow:"Radio de la emergencia",midas:!0}});this.map.data.add(t),this.emergencyRadius=t},l=function(){if(!$("#botoneraColorControl a.selected").length)return $("#botoneraColorControl").closest("div").addClass("has-error"),!1;if(!$("#iTituloComponente").val())return $("#iTituloComponente").closest("div").addClass("has-error"),!1;$("#ctrlDraw").addClass("btn-success").removeClass("btn-primary"),this.otherDrawingManager.setDrawingMode(this.otherControlSelected.overlay),this.otherDrawingManager.setMap(this.map),this.otherControlSelected.title=$("#iTituloComponente").val();for(var e=["polygonOptions","circleOptions","rectangleOptions"],a=0;a<e.length;a++)this.otherDrawingManager.set(e[a],{fillColor:this.otherControlColor});this.otherDrawingManager.set("polylineOptions",{strokeColor:this.otherControlColor}),$("#mOtrosEmergencias").modal("hide")},c=360,g=function(e){for(var a=[[]],o=360/c,t=null,r=0;c>r;r++)t=google.maps.geometry.spherical.computeOffset(e.getCenter(),e.getRadius(),o*r),a[0].push(t);return a}}).apply(VisorMapa);