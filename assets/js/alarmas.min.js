function initialize(){$.getJSON(siteUrl+"session/getMinMaxUsr",null,function(a){var e=new google.maps.LatLngBounds,i={center:new google.maps.LatLng(-33.07,-71.6),zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map($("#map").get(0),i),geozone=a.com_c_geozone;var n=GeoEncoder.utmToDecimalDegree(parseFloat(a.com_c_xmin),parseFloat(a.com_c_ymin),geozone);e.extend(new google.maps.LatLng(n[0],n[1])),n=GeoEncoder.utmToDecimalDegree(parseFloat(a.com_c_xmax),parseFloat(a.com_c_ymax),geozone),e.extend(new google.maps.LatLng(n[0],n[1])),console.log(e),$("#geozone").val(geozone),set_marker_by_inputs(),0==marcador.length&&map.fitBounds(e),ac=new google.maps.places.Autocomplete(document.getElementById("iLugarEmergencia"),{componentRestrictions:{country:"cl"}}),ac.addListener("place_changed",function(){var a=ac.getPlace();0!==a.length&&(set_marker(a.geometry.location),setInputs(a.geometry.location))})})}function set_marker(a){marcador.forEach(function(a){a.setMap(null)}),marcador=[],marcador.push(new google.maps.Marker({map:map,draggable:!0,position:a,icon:baseUrl+"assets/img/referencia.png"})),google.maps.event.addListener(marcador[0],"dragend",function(){setInputs(marcador[0].getPosition())}),map.setCenter(marcador[0].getPosition()),map.setZoom(15)}function setInputs(a){var e=GeoEncoder.decimalDegreeToUtm(parseFloat(a.lng()),parseFloat(a.lat()));$("#ins_c_coordenada_e").val(e[0]),$("#ins_c_coordenada_n").val(e[1])}function set_marker_by_inputs(){if($("#ins_c_coordenada_e").val()>0&&$("#ins_c_coordenada_n").val()>0){var a=GeoEncoder.utmToDecimalDegree(parseFloat($("#ins_c_coordenada_e").val()),parseFloat($("#ins_c_coordenada_n").val()),geozone),e=new google.maps.LatLng(parseFloat(a[0]),parseFloat(a[1]));set_marker(e)}}var content_1,content_2,Alarma={};(function(){this.inicioEdicion=function(){var a=$("#ala_ia_id").val();$("#iTiposEmergencias").jCombo(siteUrl+"emergencia/jsonTiposEmergencias"),$("#fechaEmergencia, #fechaRecepcion").datetimepicker({format:"DD-MM-YYYY HH:mm"}),$("#iComunas").jCombo(siteUrl+"session/obtenerJsonComunas",{handlerLoad:function(){$.getJSON(siteUrl+"alarma/getAlarma/id/"+a,function(a){var e=a.comunas;if(null!==e){var i=e.split(",");$("#iComunas").picklist({value:i})}else $("#iComunas").picklist();$("#eme_ia_id").val(a.eme_ia_id),$("#ala_ia_id").val(a.ala_ia_id),$("#iNombreInformante").val(a.ala_c_nombre_informante),$("#iTelefonoInformante").val(a.ala_c_telefono_informante),$("#iNombreEmergencia").val(a.ala_c_nombre_emergencia),$("#iTiposEmergencias").val(a.tip_ia_id),$("#iLugarEmergencia").val(a.ala_c_lugar_emergencia),$("#fechaEmergencia").val(a.ala_d_fecha_emergencia),$("#usuarioRecepciona").val(a.usuario),$("#fechaRecepcion").val(a.ala_d_fecha_recepcion),$("#iObservacion").val(a.ala_c_observacion),$("#ins_c_coordenada_n").val(a.ala_c_utm_lat),$("#ins_c_coordenada_e").val(a.ala_c_utm_lng),initialize()})},initial_text:null})},this.inicioIngreso=function(){$("#iTiposEmergencias").jCombo(siteUrl+"emergencia/jsonTiposEmergencias"),$("#iComunas").jCombo(siteUrl+"session/obtenerJsonComunas",{handlerLoad:function(){$("#iComunas").picklist()},initial_text:null}),$("#fechaEmergencia, #fechaRecepcion").datetimepicker({format:"DD-MM-YYYY HH:mm"})},this.inicioListado=function(){var a=this;$("#TiposEmergencias").jCombo(siteUrl+"alarma/jsonTiposEmergencias"),$("#btnBuscarAlarmas").click(this.eventoBtnBuscar),$.getScript(baseUrl+"assets/js/modulo/general/permisos.js",function(){a.eventoBtnBuscar()}),$(window).resize(function(){$("table").css("width","100%")})},this.eventoBtnBuscar=function(){var a=$("#btnBuscarAlarmas").html();$("#btnBuscarAlarmas").attr("disabled",!0).html('Buscando... <i class="fa fa-spin fa-spinner"></i>');var e=siteUrl+"alarma/jsonAlarmasDT",i=$("#iAnio").val(),n=$("#TiposEmergencias").val(),o=$("#iEstadoAlarma").val();parseInt(i)&&(e+="/anio/"+i),parseInt(n)&&(e+="/tipoEmergencia/"+n),parseInt(o)?e+="/estado/"+o:0!==parseInt(o)&&(e+="/estado/3");var t=$("#tblAlarmas").DataTable({destroy:!0});t.destroy(),$("#tblAlarmas").empty();var s=new Permisos("alarma"),l=new Permisos("emergencia");$.ajax({format:"json",cache:!1,url:e,data:"",success:function(e){var i=JSON.parse(e);i.columns[0].mRender=function(a,e,i){var n="",o="",t="";switch(parseInt(i.tip_ia_id)){case 1:case 2:o='<i class="glyphicon glyphicon-fire icono"></i>';break;case 3:o='<i class="fa fa-4x fa-flask icono"></i>';break;case 4:o='<i class="fa fa-4x fa-cloud icono"></i>';break;case 5:o='<i class="fa fa-4x fa-bullseye icono"></i>';break;case 6:o='<i class="fa fa-4x fa-life-ring icono"></i>';break;case 7:o='<i class="fa fa-4x fa-globe icono"></i>';break;case 8:o='<i class="glyphicon glyphicon-tint icono"></i>';break;case 9:case 10:o='<i class="fa fa-4x fa-medkit icono"></i>';break;case 11:o='<i class="fa fa-4x fa-bomb icono"></i>';break;case 12:case 13:o='<i class="fa fa-4x fa-user-md icono"></i>';break;case 15:o='<i class="fa fa-4x fa-bolt icono"></i>';break;case 14:o='<i class="fa fa-4x fa-bullhorn icono"></i>'}(1==i.est_ia_id||2==i.est_ia_id)&&(t="disabled");var n="";return n+='<div class="col-md-12 shadow" style="padding: 10px;">',n+='    <div class="col-md-2 text-center">'+o+"</div>",n+='    <div class="col-md-8">',n+='        <div class="form-group col-md-12">',n+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Fecha:</label>",n+='            <div class="col-md-8">',n+="                "+i.ala_d_fecha_emergencia,n+="            </div>",n+="        </div>",n+='        <div class="form-group col-md-12">',n+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Nombre:</label>",n+='            <div class="col-md-8">',n+="                "+i.ala_c_nombre_emergencia,n+="            </div>",n+="        </div>",n+='        <div class="form-group col-md-12">',n+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Tipo:</label>",n+='            <div class="col-md-8">',n+="               "+i.ala_c_tipo_emergencia,n+="            </div>",n+="        </div>",n+='        <div class="form-group col-md-12">',n+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Lugar:</label>",n+='            <div class="col-md-8">',n+="                "+i.ala_c_lugar_emergencia,n+="            </div>",n+="        </div>",n+='        <div class="form-group col-md-12">',n+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Comuna(s):</label>",n+='            <div class="col-md-8">',n+="                "+i.comunas,n+="            </div>",n+="        </div>",n+="    </div>",n+='    <div class="col-md-2 text-center">',n+='       <div class="btn-group">',l.getNuevo()&&(n+='           <a title="Generar emergencia" class="btn btn-default btn-square '+t+'" onclick=Alarma.generaEmergencia('+i.ala_ia_id+"); >",n+='               <i class="fa fa-bullhorn"></i>',n+="            </a>"),s.getEditar()&&(n+='           <a title="Editar" class="btn btn-default btn-square'+t+'" onclick=Alarma.editarAlarma('+i.ala_ia_id+")>",n+='               <i class="fa fa-pencil"></i>',n+="           </a>"),s.getEliminar()&&(n+='           <a title="Eliminar" class="btn btn-default btn-square " onclick=Alarma.eliminarAlarma('+i.ala_ia_id+")>",n+='               <i class="fa fa-trash"></i>',n+="           </a>"),n+="       </div>",n+="    </div>",n+="</div>"},$("#tblAlarmas").DataTable({destroy:!0,data:i.data,columns:i.columns,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},order:[[0,"desc"]]}),$("#pResultados").css("visibility","visible"),$("#pResultados").slideDown("slow"),$("#btnBuscarAlarmas").attr("disabled",!1).html(a)}})},this.guardarForm=function(a){if(!Utils.validaForm("frmIngresoAlarma"))return!1;var e=$("#frmIngresoAlarma").serialize();$.post(siteUrl+"alarma/guardaAlarma",e,function(e){var i,n=jQuery.parseJSON(e),o=!1;""==$("#ala_ia_id").val()?i="Se ha insertado correctamente<br>Estado email: "+n.res_mail:(i="Se ha editado correctamente<br>",o=!0),n.ala_ia_id>0?bootbox.dialog({title:"Resultado de la operacion",message:i,buttons:{danger:{label:"Cerrar",className:"btn-info",callback:function(){$("#iTiposEmergencias").val();$("#pResultados").length?1==a?location.href=siteUrl+"emergencia/generaEmergencia/id/"+n.ala_ia_id:(Alarma.eventoBtnBuscar(),Alarma.limpiar()):$("#div_tab_2").fadeOut(function(){$("#div_tab_2").html('<div class="text-center"><i class="fa fa-spin fa-spinner fa-5x"></i></div>').fadeIn(function(){$("#tab-nueva").parent().removeClass("disabled").show(),$("#div_tab_1").show().html(content_1),$("#div_tab_2").html(content_2)})})}}}}):bootbox.dialog({title:"Resultado de la operacion",message:"Error al insertar/editar",buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})})},this.eliminarAlarma=function(a){bootbox.dialog({title:"Eliminar elemento",message:"¿Está seguro que desea eliminar esta alarma?",buttons:{success:{label:"Aceptar",className:"btn-primary",callback:function(){$.get(siteUrl+"alarma/eliminarAlarma/id/"+a).done(function(a){0==a?bootbox.dialog({title:"Resultado de la operacion",message:"Se eliminó correctamente",buttons:{danger:{label:"Cerrar",className:"btn-info",callback:function(){Alarma.eventoBtnBuscar()}}}}):bootbox.dialog({title:"Resultado de la operacion",message:"Error al eliminar",buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})})}},danger:{label:"Cancelar",className:"btn-default"}}})},this.editarAlarma=function(a){$("#tab-nueva").parent().addClass("disabled").hide();var e=$("#tblAlarmas").DataTable({destroy:!0});e.destroy(),content_1=$("#div_tab_1").html(),content_2=$("#div_tab_2").html(),$("#div_tab_1").html(""),$("#div_tab_2").fadeOut(function(){$("#tblAlarmas").remove(),$("#tab-listado").html("Edición Alarma"),$(this).html('<div class="text-center"><i class="fa fa-spin fa-spinner fa-5x"></i></div>').fadeIn(function(){$(this).load(siteUrl+"alarma/editar/id/"+a,function(){$("#btnCancelarEdicion").show()})})})},this.generaEmergencia=function(a){window.open(siteUrl+"emergencia/generaEmergencia/id/"+a,"_blank")},this.limpiar=function(){$("#frmIngresoAlarma")[0].reset(),$("#iComunas").picklist("destroy"),$("#iComunas").picklist()},this.cancelarEdicion=function(){$("#div_tab_2").fadeOut(function(){$("#div_tab_2").html('<div class="text-center"><i class="fa fa-spin fa-spinner fa-5x"></i></div>').fadeIn(function(){$("#tab-listado").html("Listado"),$("#tab-nueva").parent().removeClass("disabled").show(),$("#div_tab_1").show().html(content_1),$("#div_tab_2").html(content_2),Emergencia.inicioListado()})})}}).apply(Alarma);var map=null,marcador={},geozone,marcador=[],ac;