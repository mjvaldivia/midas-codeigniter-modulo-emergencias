function initialize(){$.getJSON(siteUrl+"session/getMinMaxUsr",null,function(a){var e=new google.maps.LatLngBounds,o={center:new google.maps.LatLng(-33.07,-71.6),zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map($("#map").get(0),o),geozone=a.com_c_geozone;var i=GeoEncoder.utmToDecimalDegree(parseFloat(a.com_c_xmin),parseFloat(a.com_c_ymin),geozone);e.extend(new google.maps.LatLng(i[0],i[1])),i=GeoEncoder.utmToDecimalDegree(parseFloat(a.com_c_xmax),parseFloat(a.com_c_ymax),geozone),e.extend(new google.maps.LatLng(i[0],i[1])),map.fitBounds(e),$("#geozone").val(geozone),new google.maps.places.Autocomplete(document.getElementById("iLugarEmergencia"),{componentRestrictions:{country:"cl"}});var s=$("#iLugarEmergencia").get(0),l=new google.maps.places.SearchBox(s,{bounds:e});google.maps.event.addListener(map,"bounds_changed",function(){var a=map.getBounds();l.setBounds(a)}),l.addListener("places_changed",function(){var a=l.getPlaces();if(0!==a.length){var e=new google.maps.LatLngBounds;a.forEach(function(a){set_marker(a.geometry.location),a.geometry.viewport?e.union(a.geometry.viewport):e.extend(a.geometry.location),setInputs(a.geometry.location)})}})})}function set_marker(a){marcador.forEach(function(a){a.setMap(null)}),marcador=[],marcador.push(new google.maps.Marker({map:map,draggable:!0,position:a,icon:baseUrl+"assets/img/referencia.png"})),google.maps.event.addListener(marcador[0],"dragend",function(){setInputs(marcador[0].getPosition())}),map.setCenter(marcador[0].getPosition()),map.setZoom(15)}function setInputs(a){var e=GeoEncoder.decimalDegreeToUtm(parseFloat(a.lng()),parseFloat(a.lat()));$("#ins_c_coordenada_e").val(e[0]),$("#ins_c_coordenada_n").val(e[1])}function set_marker_by_inputs(){if($("#ins_c_coordenada_e").val()>0&&$("#ins_c_coordenada_n").val()>0){var a=GeoEncoder.utmToDecimalDegree(parseFloat($("#ins_c_coordenada_e").val()),parseFloat($("#ins_c_coordenada_n").val()),geozone),e=new google.maps.LatLng(parseFloat(a[0]),parseFloat(a[1]));set_marker(e)}}var Alarma={};(function(){this.inicioIngreso=function(){$("#iComunas").picklist(),$("#fechaEmergencia, #fechaRecepcion").datetimepicker({format:"DD-MM-YYYY HH:mm"})},this.inicioListado=function(){$("#TiposEmergencias").jCombo(siteUrl+"alarma/jsonTiposEmergencias"),$("#iEstadoAlarma").jCombo(siteUrl+"alarma/jsonEstadosAlarmas",{selected_value:3}),$("#btnBuscarAlarmas").click(this.eventoBtnBuscar),this.eventoBtnBuscar(),$(window).resize(function(){$("table").css("width","100%")})},this.eventoBtnBuscar=function(){var a=siteUrl+"alarma/jsonAlarmasDT",e=$("#iAnio").val(),o=$("#TiposEmergencias").val(),i=$("#iEstadoAlarma").val();parseInt(e)&&(a+="/anio/"+e),parseInt(o)&&(a+="/tipoEmergencia/"+o),parseInt(i)?a+="/estado/"+i:0!==parseInt(i)&&(a+="/estado/3");var s=$("#tblAlarmas").DataTable();s.destroy(),$("#tblAlarmas").empty(),$.ajax({format:"json",cache:!1,url:a,data:"",success:function(a){var e=JSON.parse(a);e.columns[0].mRender=function(a,e,o){var i="",s="",l="";switch(parseInt(o.tip_ia_id)){case 1:case 2:s='<i class="glyphicon glyphicon-fire icono"></i>';break;case 3:s='<i class="fa fa-4x fa-flask icono"></i>';break;case 4:s='<i class="fa fa-4x fa-cloud icono"></i>';break;case 5:s='<i class="fa fa-4x fa-bullseye icono"></i>';break;case 6:s='<i class="fa fa-4x fa-life-ring icono"></i>';break;case 7:s='<i class="fa fa-4x fa-globe icono"></i>';break;case 8:s='<i class="glyphicon glyphicon-tint icono"></i>';break;case 9:case 10:s='<i class="fa fa-4x fa-medkit icono"></i>';break;case 11:s='<i class="fa fa-4x fa-bomb icono"></i>';break;case 12:case 13:s='<i class="fa fa-4x fa-user-md icono"></i>';break;case 15:s='<i class="fa fa-4x fa-bolt icono"></i>';break;case 14:s='<i class="fa fa-4x fa-bullhorn icono"></i>'}(1==o.est_ia_id||2==o.est_ia_id)&&(l="disabled");var i="";return i+='<div class="col-md-12 shadow" style="padding: 10px;">',i+='    <div class="col-md-2 text-center">'+s+"</div>",i+='    <div class="col-md-8">',i+='        <div class="form-group col-md-12">',i+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Fecha:</label>",i+='            <div class="col-md-8">',i+="                "+o.ala_d_fecha_emergencia,i+="            </div>",i+="        </div>",i+='        <div class="form-group col-md-12">',i+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Nombre:</label>",i+='            <div class="col-md-8">',i+="                "+o.ala_c_nombre_emergencia,i+="            </div>",i+="        </div>",i+='        <div class="form-group col-md-12">',i+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Tipo:</label>",i+='            <div class="col-md-8">',i+="               "+o.ala_c_tipo_emergencia,i+="            </div>",i+="        </div>",i+='        <div class="form-group col-md-12">',i+="            <label class='col-md-4' style='text-align: right; margin-bottom: 0 !important;'>Lugar:</label>",i+='            <div class="col-md-8">',i+="                "+o.ala_c_lugar_emergencia,i+="            </div>",i+="        </div>",i+="    </div>",i+='    <div class="col-md-2 text-center">',i+='       <div class="btn-group">',i+='           <a title="Generar emergencia" class="btn btn-default '+l+'" onclick=Alarma.generaEmergencia('+o.ala_ia_id+"); >",i+='               <i class="fa fa-bullhorn"></i>',i+="            </a>",i+='           <a title="Editar" class="btn btn-default" onclick=Alarma.editarAlarma('+o.ala_ia_id+")>",i+='               <i class="fa fa-pencil"></i>',i+="           </a>",i+='           <a title="Eliminar" class="btn btn-default" onclick=Alarma.eliminarAlarma('+o.ala_ia_id+")>",i+='               <i class="fa fa-trash"></i>',i+="           </a>",i+="       </div>",i+="    </div>",i+="</div>"},$("#tblAlarmas").DataTable({data:e.data,columns:e.columns,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},order:[[0,"desc"]]}),$("#pResultados").css("visibility","visible"),$("#pResultados").slideDown("slow")}})},this.guardarForm=function(){if(!Utils.validaForm("frmIngresoAlarma"))return!1;var a=$("#frmIngresoAlarma").serialize();$.post(siteUrl+"alarma/guardaAlarma",a,function(a){var e=jQuery.parseJSON(a);e.ala_ia_id>0?bootbox.dialog({title:"Resultado de la operacion",message:"Se ha insertado correctamente<br>Estado email: "+e.res_mail,buttons:{danger:{label:"Cerrar",className:"btn-info",callback:function(){var e=$("#iTiposEmergencias").val();15==e?location.href=siteUrl+"alarma/paso2/id/"+a+"/tip_ia_id/"+e:$("#pResultados").length?(Alarma.eventoBtnBuscar(),Alarma.limpiar()):window.close()}}}}):bootbox.dialog({title:"Resultado de la operacion",message:"Error al insertar",buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})})},this.eliminarAlarma=function(a){bootbox.dialog({title:"Eliminar elemento",message:"¿Está seguro que desea eliminar esta alarma?",buttons:{success:{label:"Aceptar",className:"btn-primary",callback:function(){$.get(siteUrl+"alarma/eliminarAlarma/id/"+a).done(function(a){0==a?bootbox.dialog({title:"Resultado de la operacion",message:"Se eliminó correctamente",buttons:{danger:{label:"Cerrar",className:"btn-info",callback:function(){Alarma.eventoBtnBuscar()}}}}):bootbox.dialog({title:"Resultado de la operacion",message:"Error al eliminar",buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})})}},danger:{label:"Cancelar",className:"btn-default"}}})},this.editarAlarma=function(a){window.open(siteUrl+"alarma/editar/id/"+a,"_blank")},this.generaEmergencia=function(a){window.open(siteUrl+"emergencia/generaEmergencia/id/"+a,"_blank")},this.limpiar=function(){$("#frmIngresoAlarma")[0].reset(),$("#iComunas").picklist("destroy"),$("#iComunas").picklist()}}).apply(Alarma);var map,marcador={},geozone,marcador=[];google.maps.event.addDomListener(window,"load",initialize);