var ExportMap={map:null,mapOptions:null,referenciaMarker:null,emergencyMarker:null,centro:null,funciones:[]};(function(){var e=this;this.mapOptions={zoom:16,mapTypeId:google.maps.MapTypeId.ROADMAP,zoomControl:!1,streetViewControl:!1,mapTypeControl:!1},this.LoadMap=function(){try{window.parent.Emergencia.cargando()}catch(a){}this.map=new google.maps.Map(document.getElementById("dvMap"),this.mapOptions),$.get(siteUrl+"visor/obtenerJsonEmergenciaVisor/id/"+$("#eme_ia_id").val()).done(e.loadObjects.bind(this)),google.maps.event.addListenerOnce(e.map,"tilesloaded",function(){setTimeout(function(){e.renderImage()},1e3)})},this.loadObjects=function(a){var o=!1,r=!1,t=JSON.parse(a);e.map.data.setStyle(function(e){var a=null,o={};return e.getProperty("fillColor")&&(a=e.getProperty("color"),o.fillOpacity=.3,o.fillColor=e.getProperty("fillColor")),e.getProperty("strokeColor")&&(o.strokeColor=e.getProperty("strokeColor")),e.getProperty("icon")&&(o.icon=e.getProperty("icon")),o});var n=JSON.parse(t.referencia);if(n.ref_lat&&n.ref_lng&&n.geozone&&(r=!0,e.drawReferencia(n.ref_lat,n.ref_lng,n.geozone),e.centro=e.referenciaMarker.getGeometry().get()),t.geojson&&(o=!0,e.loadJson(t.geojson)),t.capas&&e.cargarCapas(t.capas),!o&&!r)for(var s=new google.maps.LatLngBounds,i=0;i<t.coordinates.length;i++){var l=t.coordinates[i];if(l.com_c_xmin&&l.com_c_ymin&&l.com_c_xmax&&l.com_c_ymax){var p=GeoEncoder.utmToDecimalDegree(parseFloat(l.com_c_xmin),parseFloat(l.com_c_ymin),l.com_c_geozone);s.extend(new google.maps.LatLng(p[0],p[1])),p=GeoEncoder.utmToDecimalDegree(parseFloat(l.com_c_xmax),parseFloat(l.com_c_ymax),l.com_c_geozone),s.extend(new google.maps.LatLng(p[0],p[1])),e.map.fitBounds(s)}}},this.loadJson=function(a){e.map.data.loadGeoJson(a,null,function(a){for(var o=0;o<a.length;o++){var r=a[o];if("LUGAR_EMERGENCIA"==r.getProperty("type")){e.map.data.remove(e.referenciaMarker),e.emergencyMarker=r;var t=new google.maps.LatLng(parseFloat(r.j.j.lat()),parseFloat(r.j.j.lng()));e.centro=t}else"RADIO_EMERGENCIA"==r.getProperty("type")&&(e.emergencyRadius=r)}e.map.setCenter(e.centro)})},this.drawReferencia=function(a,o,r){var t=GeoEncoder.utmToDecimalDegree(parseFloat(o),parseFloat(a),r),n=new google.maps.LatLng(parseFloat(t[0]),parseFloat(t[1])),s=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(n),properties:{type:"REFERENCIA",icon:baseUrl+"assets/img/referencia.png",infoWindow:"Lugar de referencia alarma",nombre:"Lugar de referencia alarma"}});e.map.data.add(s),e.referenciaMarker=s},this.cargarCapas=function(a){if(""!==a)for(var o=a.split(","),r=0;r<o.length;r++){var t=0;e.map.data.forEach(function(e){e.getProperty("TYPE")==o[r]&&t++}),t>0||$.get(siteUrl+"visor/get_json_capa/id/"+o[r],function(a){for(var o,r=JSON.parse(a),t=JSON.parse(r.json_str),n=r.propiedades.split(","),s=0;s<t.features.length;s++){o=t.features[s];var i="",l="",p="",g="",m=0,c={};switch($.each(o.properties,function(e,a){for(var o=0;o<n.length;o++)e.toLowerCase()==n[o].toLowerCase()&&m++;m>0&&"type"!==e.toLowerCase()&&("comuna"==e.toLowerCase()&&null!==a?p='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+a+"</span></td><tr>":"nombre"!=e.toLowerCase()&&"name"!=e.toLowerCase()||null===a?i+='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+a+"</span></td><tr>":g=a.toUpperCase(),c[e]=a)}),""==g&&(g=r.nombre.toUpperCase()),l="<div class='infoWindow'>",l+="<h4>"+g+"</h4><br>",l+="<div class='well'>",l+="<table>",l+=i,l+=p,l+="</table>",l+="</div>",l+="</div>",c.TYPE=o.properties.TYPE,c.infoWindow=l,c.LAYERNAME=r.nombre.toUpperCase(),o.geometry.type){case"Point":c.icon=r.icono;var d=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[0]),parseFloat(o.geometry.coordinates[1]),r.geozone),f=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(d[0]),lng:parseFloat(d[1])}),properties:c});e.map.data.add(f);break;case"Polygon":c.fillColor="#999999";for(var d,y=[[]],u=0;u<o.geometry.coordinates[0].length;u++){d=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[0][u][0]),parseFloat(o.geometry.coordinates[0][u][1]),r.geozone);var v=new google.maps.LatLng(parseFloat(d[0]),parseFloat(d[1]));y[0].push(v)}var w=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(y),properties:c});e.map.data.add(w);break;case"MultiPolygon":c.fillColor="#999999";for(var d,_=0;_<o.geometry.coordinates.length;_++)for(var u=0;u<o.geometry.coordinates[_].length;u++)for(var u=0;u<o.geometry.coordinates[_].length;u++){for(var y=[[]],h=0;h<o.geometry.coordinates[_][u].length;h++){d=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[_][u][h][0]),parseFloat(o.geometry.coordinates[_][u][h][1]),r.geozone);var v=new google.maps.LatLng(parseFloat(d[0]),parseFloat(d[1]));y[0].push(v)}var F=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(y),properties:c});e.map.data.add(F)}break;case"LineString":c.strokeColor="#0000FF";for(var d,y=[],E=0;E<o.geometry.coordinates.length;E++)d=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[E][0]),parseFloat(o.geometry.coordinates[E][1]),r.geozone),y.push({lat:parseFloat(d[0]),lng:parseFloat(d[1])});var L=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(y),properties:c});e.map.data.add(L)}}})}},this.microtime=function(){var e=(new Date).getTime(),a=parseInt(e,10);return Math.round(1e3*(e-a))/1e3+a},this.renderImage=function(){html2canvas($("#dvMap"),{useCORS:!0,onrendered:function(a){var o=a.toDataURL("image/jpg");o=o.replace(/^data:image\/(png|jpg);base64,/,"");var r={str:o,eme_ia_id:$("#eme_ia_id").val(),m:e.microtime()};$.ajax({url:siteUrl+"visor/getMapImage",dataType:"json",data:r,type:"POST",success:function(e){if(0!==e.k){try{window.parent.Emergencia.cargando()}catch(a){}window.open(siteUrl+"visor/getReporte/id/"+$("#eme_ia_id").val()+"/k/"+e.k,"_blank"),window.parent.Emergencia.closeIframe($("#eme_ia_id").val())}}})}})}}).apply(ExportMap);