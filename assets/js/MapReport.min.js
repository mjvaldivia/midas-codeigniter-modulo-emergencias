var MapReport={A:null,B:null,mapOptions:null,referenciaMarker:null,emergencyMarker:null,centro:null,funciones:[],data:null};(function(){var e=this;this.mapOptions={zoom:16,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1},this.LoadMap=function(){$.ajax({url:siteUrl+"visor/obtenerJsonEmergenciaVisor/id/"+$("#eme_ia_id").val(),method:"GET",cache:!1}).done(function(a){e.data=a,e.loadObjects(e.A)})},this.LoadMapCloned=function(a){$("#modal_"+$("#eme_ia_id").val()).scrollTop(0),Emergencia.cargando(),e.B=new google.maps.Map(document.getElementById("clon"),{mapTypeId:google.maps.MapTypeId.ROADMAP,zoomControl:!1,streetViewControl:!1,mapTypeControl:!1}),e.loadObjects(e.B),google.maps.event.addListenerOnce(e.B,"tilesloaded",function(){setTimeout(function(){e.renderImage(a)},2e3)})},this.loadObjects=function(a){a===e.A&&(a=e.A=new google.maps.Map(document.getElementById("dvMap"),e.mapOptions));var o=!1,t=e.data,r=!1,n=JSON.parse(t);a.data.setStyle(function(e){var a=null,o={};return e.getProperty("fillColor")&&(a=e.getProperty("color"),o.fillOpacity=.3,o.fillColor=e.getProperty("fillColor")),e.getProperty("strokeColor")&&(o.strokeColor=e.getProperty("strokeColor")),e.getProperty("icon")&&(o.icon=e.getProperty("icon")),o});var l=JSON.parse(n.referencia);if(l.ref_lat&&l.ref_lng&&l.geozone&&(r=!0,e.drawReferencia(l.ref_lat,l.ref_lng,l.geozone,a),e.centro=e.referenciaMarker.getGeometry().get()),n.geojson){var s=0;try{e.loadJson(n.geojson,a)}catch(i){console.log(i.message),s++}0==s&&(o=!0)}if(n.capas&&e.cargarCapas(n.capas,a),o||r)a==e.A?a.setCenter(e.centro):(a.fitBounds(e.A.getBounds()),a.setZoom(e.A.getZoom()+1));else{for(var c=new google.maps.LatLngBounds,g=0;g<n.coordinates.length;g++){var d=n.coordinates[g];if(d.com_c_xmin&&d.com_c_ymin&&d.com_c_xmax&&d.com_c_ymax){var p=GeoEncoder.utmToDecimalDegree(parseFloat(d.com_c_xmin),parseFloat(d.com_c_ymin),d.com_c_geozone);c.extend(new google.maps.LatLng(p[0],p[1])),p=GeoEncoder.utmToDecimalDegree(parseFloat(d.com_c_xmax),parseFloat(d.com_c_ymax),d.com_c_geozone),c.extend(new google.maps.LatLng(p[0],p[1]))}}a==e.A?a.fitBounds(c):(a.fitBounds(e.A.getBounds()),a.setZoom(e.A.getZoom()))}},this.loadJson=function(a,o){try{o.data.loadGeoJson(a,null,function(a){for(var t=0;t<a.length;t++){var r=a[t];if("LUGAR_EMERGENCIA"==r.getProperty("type")){o.data.remove(e.referenciaMarker),e.emergencyMarker=r;var n=new google.maps.LatLng(parseFloat(r.j.j.lat()),parseFloat(r.j.j.lng()));e.centro=n}else"RADIO_EMERGENCIA"==r.getProperty("type")&&(e.emergencyRadius=r)}})}catch(t){}},this.drawReferencia=function(a,o,t,r){var n=GeoEncoder.utmToDecimalDegree(parseFloat(o),parseFloat(a),t),l=new google.maps.LatLng(parseFloat(n[0]),parseFloat(n[1])),s=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(l),properties:{type:"REFERENCIA",icon:baseUrl+"assets/img/referencia.png",infoWindow:"Lugar de referencia alarma",nombre:"Lugar de referencia alarma"}});r.data.add(s),e.referenciaMarker=s},this.cargarCapas=function(e,a){if(""!==e)for(var o=e.split(","),t=0;t<o.length;t++){var r=0;a.data.forEach(function(e){e.getProperty("TYPE")==o[t]&&r++}),r>0||$.get(siteUrl+"visor/get_json_capa/id/"+o[t],function(e){for(var o,t=JSON.parse(e),r=JSON.parse(t.json_str),n=t.propiedades.split(","),l=0;l<r.features.length;l++){o=r.features[l];var s="",i="",c="",g="",d=0,p={};switch($.each(o.properties,function(e,a){for(var o=0;o<n.length;o++)e.toLowerCase()==n[o].toLowerCase()&&d++;d>0&&"type"!==e.toLowerCase()&&("comuna"==e.toLowerCase()&&null!==a?c='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+a+"</span></td><tr>":"nombre"!=e.toLowerCase()&&"name"!=e.toLowerCase()||null===a?s+='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+a+"</span></td><tr>":g=a.toUpperCase(),p[e]=a)}),""==g&&(g=t.nombre.toUpperCase()),i="<div class='infoWindow'>",i+="<h4>"+g+"</h4><br>",i+="<div class='well'>",i+="<table>",i+=s,i+=c,i+="</table>",i+="</div>",i+="</div>",p.TYPE=o.properties.TYPE,p.infoWindow=i,p.LAYERNAME=t.nombre.toUpperCase(),o.geometry.type){case"Point":p.icon=t.icono;var m=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[0]),parseFloat(o.geometry.coordinates[1]),t.geozone),u=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(m[0]),lng:parseFloat(m[1])}),properties:p});a.data.add(u);break;case"Polygon":p.fillColor="#999999";for(var m,f=[[]],v=0;v<o.geometry.coordinates[0].length;v++){m=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[0][v][0]),parseFloat(o.geometry.coordinates[0][v][1]),t.geozone);var y=new google.maps.LatLng(parseFloat(m[0]),parseFloat(m[1]));f[0].push(y)}var b=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(f),properties:p});a.data.add(b);break;case"MultiPolygon":p.fillColor="#999999";for(var m,_=0;_<o.geometry.coordinates.length;_++)for(var v=0;v<o.geometry.coordinates[_].length;v++)for(var v=0;v<o.geometry.coordinates[_].length;v++){for(var f=[[]],h=0;h<o.geometry.coordinates[_][v].length;h++){m=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[_][v][h][0]),parseFloat(o.geometry.coordinates[_][v][h][1]),t.geozone);var y=new google.maps.LatLng(parseFloat(m[0]),parseFloat(m[1]));f[0].push(y)}var w=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(f),properties:p});a.data.add(w)}break;case"LineString":p.strokeColor="#0000FF";for(var m,f=[],C=0;C<o.geometry.coordinates.length;C++)m=GeoEncoder.utmToDecimalDegree(parseFloat(o.geometry.coordinates[C][0]),parseFloat(o.geometry.coordinates[C][1]),t.geozone),f.push({lat:parseFloat(m[0]),lng:parseFloat(m[1])});var F=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(f),properties:p});a.data.add(F)}}})}},this.microtime=function(){var e=(new Date).getTime(),a=parseInt(e,10);return Math.round(1e3*(e-a))/1e3+a},this.renderImage=function(a){html2canvas($("#clon"),{useCORS:!0,onrendered:function(o){var t=o.toDataURL("image/jpg");t=t.replace(/^data:image\/(png|jpg);base64,/,"");var r={str:t,eme_ia_id:$("#eme_ia_id").val(),m:e.microtime()};$.ajax({url:siteUrl+"visor/getMapImage",dataType:"json",data:r,type:"POST",success:function(e){if(0!==e.k)if(Emergencia.cargando(),1==a)window.open(siteUrl+"visor/getReporte/id/"+$("#eme_ia_id").val()+"/k/"+e.k,"_blank");else{var o=$("#form_reporte").serialize(),t=$("#tokenfield").val(),r=t.split(","),n="";$.each(r,function(e,a){""!==n&&(n+=","),n+=a.replace(/\((.*?)\)/,"").trim()}),o+="&destino="+n,$.ajax({url:siteUrl+"visor/enviarMail/id/"+$("#eme_ia_id").val()+"/k/"+e.k,dataType:"json",data:o,type:"POST",success:function(e){0==e?bootbox.dialog({title:"Envío de correo",message:"Enviado correctamente",buttons:{success:{label:"Aceptar",className:"btn-primary"}}}):bootbox.dialog({title:"Envío de correo",message:"Error al enviar email",buttons:{success:{label:"Aceptar",className:"btn-primary"}}})}})}}})}})},this.cloneMap=function(){e.LoadMapCloned(1)},this.dibujaTablaDocs=function(){var e=$("#ala_ia_id").val();$("#tabla_doc").dataTable().fnDestroy(),$("#tabla_doc").dataTable({ajax:{url:siteUrl+"archivo/getDocs/id/"+e+"/tipo/5",type:"POST",async:!0},bPaginate:!1,bFilter:!1,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},aoColumns:[null,null,null,{sClass:"text-center"},null],aoColumnDefs:[{bSortable:!1,aTargets:[4]}]}),$("#tabla_doc").wrap("<div class='col-sm-12' style='padding-left:0px !important;'></div>")},this.send_mail=function(){return Utils.validaForm("form_reporte")?void bootbox.dialog({title:"Envío de correo",message:"¿Está seguro que desea enviar el correo?",buttons:{success:{label:"Aceptar",className:"btn-primary",callback:function(){e.LoadMapCloned(2)}},danger:{label:"Cancelar",className:"btn-default"}}}):!1}}).apply(MapReport),$.get(siteUrl+"visor/getmails/").done(function(e){var a=$.parseJSON(e);$("#tokenfield").on("tokenfield:createtoken",function(e){var a=e.attrs.value.split("|");e.attrs.value=a[1]||a[0],e.attrs.label=a[1]?a[0]+" ("+a[1]+")":a[0];var o=$(this).tokenfield("getTokens");$.each(o,function(a,o){o.value===e.attrs.value&&(e.preventDefault(),alert("Ya está agregado"))})}).on("tokenfield:createdtoken",function(e){var a=/\S+@\S+\.\S+/,o=a.test(e.attrs.value);o||$(e.relatedTarget).addClass("invalid")}).on("tokenfield:edittoken",function(e){if(e.attrs.label!==e.attrs.value){var a=e.attrs.label.split(" (");e.attrs.value=a[0]+"|"+e.attrs.value}}).on("tokenfield:removedtoken",function(e){}).tokenfield({autocomplete:{source:a,delay:100},showAutocompleteOnFocus:!0,delimiter:[",",";"," "]})});