var MapReport={A:null,B:null,mapOptions:null,referenciaMarker:null,emergencyMarker:null,centro:null,funciones:[],data:null};(function(){var e=this;this.mapOptions={zoom:16,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1},this.LoadMap=function(){e.A=new google.maps.Map(document.getElementById("dvMap"),e.mapOptions),$.get(siteUrl+"visor/obtenerJsonEmergenciaVisor/id/"+$("#eme_ia_id").val()).done(function(o){e.data=o,e.loadObjects(e.A)})},this.LoadMapCloned=function(){e.B=new google.maps.Map(document.getElementById("clon"),{mapTypeId:google.maps.MapTypeId.ROADMAP,zoomControl:!1,streetViewControl:!1,mapTypeControl:!1}),e.loadObjects(e.B),google.maps.event.addListenerOnce(e.B,"tilesloaded",function(){setTimeout(function(){e.renderImage()},2e3)})},this.loadObjects=function(o){var a=!1,t=e.data,r=!1,n=JSON.parse(t);o.data.setStyle(function(e){var o=null,a={};return e.getProperty("fillColor")&&(o=e.getProperty("color"),a.fillOpacity=.3,a.fillColor=e.getProperty("fillColor")),e.getProperty("strokeColor")&&(a.strokeColor=e.getProperty("strokeColor")),e.getProperty("icon")&&(a.icon=e.getProperty("icon")),a});var l=JSON.parse(n.referencia);if(l.ref_lat&&l.ref_lng&&l.geozone&&(r=!0,e.drawReferencia(l.ref_lat,l.ref_lng,l.geozone,o),e.centro=e.referenciaMarker.getGeometry().get()),n.geojson&&(a=!0,e.loadJson(n.geojson,o)),n.capas&&e.cargarCapas(n.capas,o),a||r)o==e.A?o.setCenter(e.centro):(o.fitBounds(e.A.getBounds()),o.setZoom(e.A.getZoom()+1));else{for(var s=new google.maps.LatLngBounds,i=0;i<n.coordinates.length;i++){var g=n.coordinates[i];if(g.com_c_xmin&&g.com_c_ymin&&g.com_c_xmax&&g.com_c_ymax){var p=GeoEncoder.utmToDecimalDegree(parseFloat(g.com_c_xmin),parseFloat(g.com_c_ymin),g.com_c_geozone);s.extend(new google.maps.LatLng(p[0],p[1])),p=GeoEncoder.utmToDecimalDegree(parseFloat(g.com_c_xmax),parseFloat(g.com_c_ymax),g.com_c_geozone),s.extend(new google.maps.LatLng(p[0],p[1]))}}o==e.A?o.fitBounds(s):(o.fitBounds(e.A.getBounds()),o.setZoom(e.A.getZoom()+1))}},this.loadJson=function(o,a){a.data.loadGeoJson(o,null,function(o){for(var t=0;t<o.length;t++){var r=o[t];if("LUGAR_EMERGENCIA"==r.getProperty("type")){a.data.remove(e.referenciaMarker),e.emergencyMarker=r;var n=new google.maps.LatLng(parseFloat(r.j.j.lat()),parseFloat(r.j.j.lng()));e.centro=n}else"RADIO_EMERGENCIA"==r.getProperty("type")&&(e.emergencyRadius=r)}})},this.drawReferencia=function(o,a,t,r){var n=GeoEncoder.utmToDecimalDegree(parseFloat(a),parseFloat(o),t),l=new google.maps.LatLng(parseFloat(n[0]),parseFloat(n[1])),s=new google.maps.Data.Feature({geometry:new google.maps.Data.Point(l),properties:{type:"REFERENCIA",icon:baseUrl+"assets/img/referencia.png",infoWindow:"Lugar de referencia alarma",nombre:"Lugar de referencia alarma"}});r.data.add(s),e.referenciaMarker=s},this.cargarCapas=function(e,o){if(""!==e)for(var a=e.split(","),t=0;t<a.length;t++){var r=0;o.data.forEach(function(e){e.getProperty("TYPE")==a[t]&&r++}),r>0||$.get(siteUrl+"visor/get_json_capa/id/"+a[t],function(e){for(var a,t=JSON.parse(e),r=JSON.parse(t.json_str),n=t.propiedades.split(","),l=0;l<r.features.length;l++){a=r.features[l];var s="",i="",g="",p="",d=0,c={};switch($.each(a.properties,function(e,o){for(var a=0;a<n.length;a++)e.toLowerCase()==n[a].toLowerCase()&&d++;d>0&&"type"!==e.toLowerCase()&&("comuna"==e.toLowerCase()&&null!==o?g='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+o+"</span></td><tr>":"nombre"!=e.toLowerCase()&&"name"!=e.toLowerCase()||null===o?s+='<tr><td style="width:40%;">'+e+'</td><td><span style="padding-left:10px;">'+o+"</span></td><tr>":p=o.toUpperCase(),c[e]=o)}),""==p&&(p=t.nombre.toUpperCase()),i="<div class='infoWindow'>",i+="<h4>"+p+"</h4><br>",i+="<div class='well'>",i+="<table>",i+=s,i+=g,i+="</table>",i+="</div>",i+="</div>",c.TYPE=a.properties.TYPE,c.infoWindow=i,c.LAYERNAME=t.nombre.toUpperCase(),a.geometry.type){case"Point":c.icon=t.icono;var m=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[0]),parseFloat(a.geometry.coordinates[1]),t.geozone),u=new google.maps.Data.Feature({geometry:new google.maps.Data.Point({lat:parseFloat(m[0]),lng:parseFloat(m[1])}),properties:c});o.data.add(u);break;case"Polygon":c.fillColor="#999999";for(var m,f=[[]],y=0;y<a.geometry.coordinates[0].length;y++){m=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[0][y][0]),parseFloat(a.geometry.coordinates[0][y][1]),t.geozone);var v=new google.maps.LatLng(parseFloat(m[0]),parseFloat(m[1]));f[0].push(v)}var w=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(f),properties:c});o.data.add(w);break;case"MultiPolygon":c.fillColor="#999999";for(var m,_=0;_<a.geometry.coordinates.length;_++)for(var y=0;y<a.geometry.coordinates[_].length;y++)for(var y=0;y<a.geometry.coordinates[_].length;y++){for(var f=[[]],h=0;h<a.geometry.coordinates[_][y].length;h++){m=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[_][y][h][0]),parseFloat(a.geometry.coordinates[_][y][h][1]),t.geozone);var v=new google.maps.LatLng(parseFloat(m[0]),parseFloat(m[1]));f[0].push(v)}var F=new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon(f),properties:c});o.data.add(F)}break;case"LineString":c.strokeColor="#0000FF";for(var m,f=[],k=0;k<a.geometry.coordinates.length;k++)m=GeoEncoder.utmToDecimalDegree(parseFloat(a.geometry.coordinates[k][0]),parseFloat(a.geometry.coordinates[k][1]),t.geozone),f.push({lat:parseFloat(m[0]),lng:parseFloat(m[1])});var C=new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(f),properties:c});o.data.add(C)}}})}},this.microtime=function(){var e=(new Date).getTime(),o=parseInt(e,10);return Math.round(1e3*(e-o))/1e3+o},this.renderImage=function(){html2canvas($("#clon"),{useCORS:!0,onrendered:function(o){var a=o.toDataURL("image/jpg");a=a.replace(/^data:image\/(png|jpg);base64,/,"");var t={str:a,eme_ia_id:$("#eme_ia_id").val(),m:e.microtime()};$.ajax({url:siteUrl+"visor/getMapImage",dataType:"json",data:t,type:"POST",success:function(e){0!==e.k&&window.open(siteUrl+"visor/getReporte/id/"+$("#eme_ia_id").val()+"/k/"+e.k,"_blank")}})}})},this.cloneMap=function(){e.LoadMapCloned()}}).apply(MapReport),$("#tokenfield").on("tokenfield:createtoken",function(e){var o=e.attrs.value.split("|");e.attrs.value=o[1]||o[0],e.attrs.label=o[1]?o[0]+" ("+o[1]+")":o[0]}).on("tokenfield:createdtoken",function(e){var o=/\S+@\S+\.\S+/,a=o.test(e.attrs.value);a||$(e.relatedTarget).addClass("invalid")}).on("tokenfield:edittoken",function(e){if(e.attrs.label!==e.attrs.value){var o=e.attrs.label.split(" (");e.attrs.value=o[0]+"|"+e.attrs.value}}).on("tokenfield:removedtoken",function(e){alert("Token removed! Token value was: "+e.attrs.value)}).tokenfield(),$("#tokenfield").tokenfield({autocomplete:{source:["red","blue","green","yellow","violet","brown","purple","black","white"],delay:100},showAutocompleteOnFocus:!0});