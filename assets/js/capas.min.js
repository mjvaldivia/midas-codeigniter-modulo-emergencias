var Layer={};(function(){this.initList=function(){$("#tblCapas").DataTable({ajax:{url:siteUrl+"capas/getCapas",type:"POST",async:!0},destroy:!0,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"}})},this.initSave=function(){$("#input-icon").fileinput({language:"es",multiple:!1,uploadAsync:!0,initialCaption:"Seleccione Icono",allowedFileTypes:["image"],uploadUrl:siteUrl+"emergencia/subir_IconTemp",dropZoneTitle:""}),$("#input-capa").fileinput({language:"es",multiple:!0,uploadAsync:!0,initialCaption:"Seleccione una o varias capas GeoJson",uploadUrl:siteUrl+"emergencia/subir_CapaTemp"}),$("#input-icon").on("filebatchuploadsuccess",function(a,e){$("#icon").val(e.response.nombre_cache_id),$("#img_icon").attr("src",baseUrl+""+e.response.ruta)}),$("#iCategoria").jCombo(siteUrl+"visor/obtenerJsonCatCoberturas"),$("#input-capa").on("filebatchuploadsuccess",function(a,e){if(0==e.response.uploaded){var i="El (los) siguiente(s) archivos no son válidos:<br>";$.each(e.response.error_filenames,function(a,e){i+="-"+e+"<br>"}),bootbox.dialog({title:"Resultado de la operacion",message:i,buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})}if(0!=e.response.filenames.length){var t=e.response.properties.data,s=e.response.filenames.data;$("#tabla_propiedades").DataTable().destroy(),$("#tabla_comunas").DataTable().destroy(),$("#tabla_propiedades").DataTable({data:t,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},bPaginate:!1,order:[[0,"desc"]],initComplete:function(){$("#div_properties").slideDown("slow")}}),$("#tabla_comunas").DataTable({data:s,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},order:[[0,"desc"]],bPaginate:!1,initComplete:function(){$(".iComunas").jCombo(siteUrl+"session/obtenerJsonComunas"),$("#div_comunas").slideDown("slow")}})}})},this.guardar=function(a,e){var i=$(e).html();if($(e).attr("disabled",!0).html('Guardando... <i class="fa fa-spin fa-spinner"></i>'),void 0===a.capa_edicion){if(!Utils.validaForm($(a).attr("id")))return void $(e).attr("disabled",!1).html(i)}else{var t="";if(""==a.nombre_editar.value&&(t+="- Nombre de capa no puede quedar vacío<br/>"),""==a.iCategoria_editar.value&&(t+="- Debe seleccionar categoría de la capa<br/>"),0==$(".propiedades:checked").length&&(t+="- Debe seleccionar por lo menos una propiedad de la capa<br/>"),""!=t)return bootbox.dialog({title:"Error",message:t,buttons:{danger:{label:"Cerrar",className:"btn-danger"}}}),void $(e).attr("disabled",!1).html(i)}var s=$(a).serialize();s+=void 0===a.capa_edicion?"&items="+parseInt($("#tabla_comunas tr").length-1):"&items="+parseInt($("#tabla_comunas_editar tr").length-1),$.post(siteUrl+"visor/guardarCapa",s,function(t){1==t?bootbox.dialog({title:"Resultado de la operacion",message:"Se ha guardado con éxito.",buttons:{danger:{label:"Aceptar",className:"btn-info",callback:function(){void 0===a.capa_edicion?location.reload():$("#tab3").fadeOut(function(){$("#tab-editar").fadeOut(function(){$(this).removeClass("active"),$(this).prev().addClass("active"),$("#tab2").addClass("active").show(),Layer.initList()})})}}}}):bootbox.dialog({title:"Resultado de la operacion",message:"Una o más capas no se han guardado",buttons:{danger:{label:"Cerrar",className:"btn-danger",callback:function(){$(e).attr("disabled",!1).html(i)}}}})}).fail(function(){$(e).attr("disabled",!1).html(i)})},this.eliminarCapa=function(a){$.post(siteUrl+"capas/validarCapaEmergencia",{capa:a},function(e){if(1==e.estado)var i="La capa a eliminar se encuentra asociada a una Emergencia. Desea eliminarla de todas formas?";else var i="Desea eliminar esta capa?";bootbox.confirm(i,function(e){e&&$.post(siteUrl+"capas/eliminarCapa",{capa:a},function(a){1==a.estado?bootbox.alert(a.mensaje,function(){Layer.initList()}):bootbox.dialog({title:"Error",message:a.mensaje})},"json").fail(function(){bootbox.dialog({title:"Error en sistema",message:"Intente nuevamente o comuníquese con Administrador"})})})},"json").fail(function(){bootbox.dialog({title:"Error en sistema",message:"Intente nuevamente o comuníquese con Administrador"})})},this.editarCapa=function(a){$("#tab-editar").fadeIn(function(){$("#ul-tabs").find("li.active").removeClass("active"),$("#tab-content").find("div.tab-pane.active").removeClass("active"),$(this).addClass("active"),$.post(siteUrl+"capas/editarCapa",{capa:a},function(a){$("#div_tab_3").html(a),$("#tab3").addClass("active").show()},"html")})},this.initSaveEdicion=function(){$("#input-icon-editar").fileinput({language:"es",multiple:!1,uploadAsync:!0,initialCaption:"Seleccione Icono",allowedFileTypes:["image"],uploadUrl:siteUrl+"emergencia/subir_IconTemp",dropZoneTitle:""}),$("#input-capa-editar").fileinput({language:"es",multiple:!1,uploadAsync:!0,initialCaption:"Seleccione una capa GeoJson",uploadUrl:siteUrl+"emergencia/subir_CapaTemp"}),$("#input-icon-editar").on("filebatchuploadsuccess",function(a,e){$("#icon-editar").val(e.response.nombre_cache_id),$("#img_icon_editar").attr("src",baseUrl+""+e.response.ruta)}),$("#input-capa-editar").on("filebatchuploadsuccess",function(a,e){if(0==e.response.uploaded){var i="El (los) siguiente(s) archivos no son válidos:<br>";$.each(e.response.error_filenames,function(a,e){i+="-"+e+"<br>"}),bootbox.dialog({title:"Resultado de la operacion",message:i,buttons:{danger:{label:"Cerrar",className:"btn-danger"}}})}if(0!=e.response.filenames.length){var t=e.response.properties.data,s=e.response.filenames.data;$("#nombre_geojson").html(""),$("#tabla_propiedades-editar").DataTable().destroy(),$("#tabla_comunas_editar").DataTable().destroy(),$("#tabla_propiedades-editar").DataTable({data:t,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},bPaginate:!1,order:[[0,"desc"]],initComplete:function(){$("#div_properties-editar").slideDown("slow")}}),$("#tabla_comunas_editar").DataTable({data:s,language:{url:baseUrl+"assets/lib/DataTables-1.10.8/Spanish.json"},order:[[0,"desc"]],initComplete:function(){$(".iComunas").jCombo(siteUrl+"session/obtenerJsonComunas"),$("#div_comunas_editar").slideDown("slow")}})}})},this.cancelarEdicion=function(){$("#tab3").fadeOut(function(){$("#tab-editar").fadeOut(function(){$(this).removeClass("active"),$(this).prev().addClass("active"),$("#tab2").addClass("active").show()})})}}).apply(Layer);